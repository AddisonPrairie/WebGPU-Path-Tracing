(()=>{"use strict";var e={12:(e,r,t)=>{t.d(r,{h:()=>a}),e=t.hmd(e);var n,a=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e={}){var r,t,a=void 0!==e?e:{};a.ready=new Promise(((e,n)=>{r=e,t=n}));var o,i=Object.assign({},a),s="";"undefined"!=typeof document&&document.currentScript&&(s=document.currentScript.src),n&&(s=n),s=0!==s.indexOf("blob:")?s.substr(0,s.replace(/[?#].*/,"").lastIndexOf("/")+1):"",a.print||console.log.bind(console);var u,l,c=a.printErr||console.error.bind(console);Object.assign(a,i),i=null,a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.quit&&a.quit,a.wasmBinary&&(u=a.wasmBinary),a.noExitRuntime,"object"!=typeof WebAssembly&&x("no native wasm support detected");var f,d,p=!1;function m(){var e=l.buffer;a.HEAP8=f=new Int8Array(e),a.HEAP16=new Int16Array(e),a.HEAP32=new Int32Array(e),a.HEAPU8=d=new Uint8Array(e),a.HEAPU16=new Uint16Array(e),a.HEAPU32=new Uint32Array(e),a.HEAPF32=new Float32Array(e),a.HEAPF64=new Float64Array(e)}var v=[],y=[],h=[],b=0,g=null,w=null;function x(e){a.onAbort&&a.onAbort(e),c(e="Aborted("+e+")"),p=!0,e+=". Build with -sASSERTIONS for more info.";var r=new WebAssembly.RuntimeError(e);throw t(r),r}var E,S;function P(e){return e.startsWith("data:application/octet-stream;base64,")}function B(e){try{if(e==E&&u)return new Uint8Array(u);if(o)return o(e);throw"both async and sync fetching of the wasm failed"}catch(e){x(e)}}function A(e,r,t){return function(e){return u||"function"!=typeof fetch?Promise.resolve().then((()=>B(e))):fetch(e,{credentials:"same-origin"}).then((r=>{if(!r.ok)throw"failed to load wasm binary file at '"+e+"'";return r.arrayBuffer()})).catch((()=>B(e)))}(e).then((e=>WebAssembly.instantiate(e,r))).then((e=>e)).then(t,(e=>{c("failed to asynchronously prepare wasm: "+e),x(e)}))}function z(e){for(;e.length>0;)e.shift()(a)}function k(e){var r=e-l.buffer.byteLength+65535>>>16;try{return l.grow(r),m(),1}catch(e){}}function R(e){return a["_"+e]}P(E="bvhbuild.wasm")||(S=E,E=a.locateFile?a.locateFile(S,s):s+S);var M="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function _(e,r,t,n,a){var o={string:e=>{var r=0;return null!=e&&0!==e&&(r=function(e){var r=function(e){for(var r=0,t=0;t<e.length;++t){var n=e.charCodeAt(t);n<=127?r++:n<=2047?r+=2:n>=55296&&n<=57343?(r+=4,++t):r+=3}return r}(e)+1,t=O(r);return function(e,r,t){!function(e,r,t,n){if(!(n>0))return 0;for(var a=t+n-1,o=0;o<e.length;++o){var i=e.charCodeAt(o);if(i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++o)),i<=127){if(t>=a)break;r[t++]=i}else if(i<=2047){if(t+1>=a)break;r[t++]=192|i>>6,r[t++]=128|63&i}else if(i<=65535){if(t+2>=a)break;r[t++]=224|i>>12,r[t++]=128|i>>6&63,r[t++]=128|63&i}else{if(t+3>=a)break;r[t++]=240|i>>18,r[t++]=128|i>>12&63,r[t++]=128|i>>6&63,r[t++]=128|63&i}}r[t]=0}(e,d,r,t)}(e,t,r),t}(e)),r},array:e=>{var r,t,n=O(e.length);return r=e,t=n,f.set(r,t),n}},i=R(e),s=[],u=0;if(n)for(var l=0;l<n.length;l++){var c=o[t[l]];c?(0===u&&(u=T()),s[l]=c(n[l])):s[l]=n[l]}var p=i.apply(null,s);return function(e){return 0!==u&&C(u),function(e){return"string"===r?(t=e)?function(e,r,t){for(var n=r+t,a=r;e[a]&&!(a>=n);)++a;if(a-r>16&&e.buffer&&M)return M.decode(e.subarray(r,a));for(var o="";r<a;){var i=e[r++];if(128&i){var s=63&e[r++];if(192!=(224&i)){var u=63&e[r++];if((i=224==(240&i)?(15&i)<<12|s<<6|u:(7&i)<<18|s<<12|u<<6|63&e[r++])<65536)o+=String.fromCharCode(i);else{var l=i-65536;o+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else o+=String.fromCharCode((31&i)<<6|s)}else o+=String.fromCharCode(i)}return o}(d,t,n):"":"boolean"===r?Boolean(e):e;var t,n}(e)}(p)}var U,F={a:function(e){var r=d.length,t=2147483648;if((e>>>=0)>t)return!1;for(var n,a=1;a<=4;a*=2){var o=r*(1+.2/a);if(o=Math.min(o,e+100663296),k(Math.min(t,(n=Math.max(e,o))+(65536-n%65536)%65536)))return!0}return!1}},T=(function(){var e,r,n,o,i={a:F};function s(e,r){var t,n=e.exports;return a.asm=n,l=a.asm.b,m(),a.asm.f,t=a.asm.c,y.unshift(t),function(e){if(b--,a.monitorRunDependencies&&a.monitorRunDependencies(b),0==b&&(null!==g&&(clearInterval(g),g=null),w)){var r=w;w=null,r()}}(),n}if(b++,a.monitorRunDependencies&&a.monitorRunDependencies(b),a.instantiateWasm)try{return a.instantiateWasm(i,s)}catch(e){c("Module.instantiateWasm callback failed with error: "+e),t(e)}(e=u,r=E,n=i,o=function(e){s(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||P(r)||"function"!=typeof fetch?A(r,n,o):fetch(r,{credentials:"same-origin"}).then((e=>WebAssembly.instantiateStreaming(e,n).then(o,(function(e){return c("wasm streaming compile failed: "+e),c("falling back to ArrayBuffer instantiation"),A(r,n,o)}))))).catch(t)}(),a._bvhbuild=function(){return(a._bvhbuild=a.asm.d).apply(null,arguments)},a._malloc=function(){return(a._malloc=a.asm.e).apply(null,arguments)},function(){return(T=a.asm.g).apply(null,arguments)}),C=function(){return(C=a.asm.h).apply(null,arguments)},O=function(){return(O=a.asm.i).apply(null,arguments)};function I(){function e(){U||(U=!0,a.calledRun=!0,p||(z(y),r(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)e=a.postRun.shift(),h.unshift(e);var e;z(h)}()))}b>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)e=a.preRun.shift(),v.unshift(e);var e;z(v)}(),b>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),e()}),1)):e()))}if(a.ccall=_,a.cwrap=function(e,r,t,n){var a=!t||t.every((e=>"number"===e||"boolean"===e));return"string"!==r&&a&&!n?R(e):function(){return _(e,r,t,arguments)}},w=function e(){U||I(),U||(w=e)},a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return I(),e.ready});"object"==typeof exports?e.exports=a:"function"==typeof define&&t.amdO?define([],(function(){return a})):"object"==typeof exports&&(exports.bvhbuild=a)},698:(e,r,t)=>{t.d(r,{Y:()=>a}),e=t.hmd(e);var n,a=(n="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e={}){var r,t,a=void 0!==e?e:{};a.ready=new Promise(((e,n)=>{r=e,t=n}));var o,i,s,u=Object.assign({},a),l="";"undefined"!=typeof document&&document.currentScript&&(l=document.currentScript.src),n&&(l=n),l=0!==l.indexOf("blob:")?l.substr(0,l.replace(/[?#].*/,"").lastIndexOf("/")+1):"",o=e=>{var r=new XMLHttpRequest;return r.open("GET",e,!1),r.send(null),r.responseText},i=(e,r,t)=>{var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=()=>{200==n.status||0==n.status&&n.response?r(n.response):t()},n.onerror=t,n.send(null)};var c,f,d=a.print||console.log.bind(console),p=a.printErr||console.error.bind(console);Object.assign(a,u),u=null,a.arguments&&a.arguments,a.thisProgram&&a.thisProgram,a.quit&&a.quit,a.wasmBinary&&(c=a.wasmBinary),a.noExitRuntime,"object"!=typeof WebAssembly&&R("no native wasm support detected");var m,v,y,h,b,g=!1;function w(){var e=f.buffer;a.HEAP8=m=new Int8Array(e),a.HEAP16=y=new Int16Array(e),a.HEAP32=h=new Int32Array(e),a.HEAPU8=v=new Uint8Array(e),a.HEAPU16=new Uint16Array(e),a.HEAPU32=b=new Uint32Array(e),a.HEAPF32=new Float32Array(e),a.HEAPF64=new Float64Array(e)}var x=[],E=[],S=[],P=0,B=null,A=null;function z(e){P++,a.monitorRunDependencies&&a.monitorRunDependencies(P)}function k(e){if(P--,a.monitorRunDependencies&&a.monitorRunDependencies(P),0==P&&(null!==B&&(clearInterval(B),B=null),A)){var r=A;A=null,r()}}function R(e){a.onAbort&&a.onAbort(e),p(e="Aborted("+e+")"),g=!0,e+=". Build with -sASSERTIONS for more info.";var r=new WebAssembly.RuntimeError(e);throw t(r),r}var M,_,U,F;function T(e){return e.startsWith("data:application/octet-stream;base64,")}function C(e){try{if(e==M&&c)return new Uint8Array(c);if(s)return s(e);throw"both async and sync fetching of the wasm failed"}catch(e){R(e)}}function O(e,r,t){return function(e){return c||"function"!=typeof fetch?Promise.resolve().then((()=>C(e))):fetch(e,{credentials:"same-origin"}).then((r=>{if(!r.ok)throw"failed to load wasm binary file at '"+e+"'";return r.arrayBuffer()})).catch((()=>C(e)))}(e).then((e=>WebAssembly.instantiate(e,r))).then((e=>e)).then(t,(e=>{p("failed to asynchronously prepare wasm: "+e),R(e)}))}function I(e){for(;e.length>0;)e.shift()(a)}T(M="hdrToFloats.wasm")||(_=M,M=a.locateFile?a.locateFile(_,l):l+_);var G={isAbs:e=>"/"===e.charAt(0),splitPath:e=>/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1),normalizeArray:(e,r)=>{for(var t=0,n=e.length-1;n>=0;n--){var a=e[n];"."===a?e.splice(n,1):".."===a?(e.splice(n,1),t++):t&&(e.splice(n,1),t--)}if(r)for(;t;t--)e.unshift("..");return e},normalize:e=>{var r=G.isAbs(e),t="/"===e.substr(-1);return(e=G.normalizeArray(e.split("/").filter((e=>!!e)),!r).join("/"))||r||(e="."),e&&t&&(e+="/"),(r?"/":"")+e},dirname:e=>{var r=G.splitPath(e),t=r[0],n=r[1];return t||n?(n&&(n=n.substr(0,n.length-1)),t+n):"."},basename:e=>{if("/"===e)return"/";var r=(e=(e=G.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return-1===r?e:e.substr(r+1)},join:function(){var e=Array.prototype.slice.call(arguments);return G.normalize(e.join("/"))},join2:(e,r)=>G.normalize(e+"/"+r)};function D(e){return(D=function(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues)return e=>crypto.getRandomValues(e);R("initRandomDevice")}())(e)}var q={resolve:function(){for(var e="",r=!1,t=arguments.length-1;t>=-1&&!r;t--){var n=t>=0?arguments[t]:K.cwd();if("string"!=typeof n)throw new TypeError("Arguments to path.resolve must be strings");if(!n)return"";e=n+"/"+e,r=G.isAbs(n)}return(r?"/":"")+(e=G.normalizeArray(e.split("/").filter((e=>!!e)),!r).join("/"))||"."},relative:(e,r)=>{function t(e){for(var r=0;r<e.length&&""===e[r];r++);for(var t=e.length-1;t>=0&&""===e[t];t--);return r>t?[]:e.slice(r,t-r+1)}e=q.resolve(e).substr(1),r=q.resolve(r).substr(1);for(var n=t(e.split("/")),a=t(r.split("/")),o=Math.min(n.length,a.length),i=o,s=0;s<o;s++)if(n[s]!==a[s]){i=s;break}var u=[];for(s=i;s<n.length;s++)u.push("..");return(u=u.concat(a.slice(i))).join("/")}};function L(e){for(var r=0,t=0;t<e.length;++t){var n=e.charCodeAt(t);n<=127?r++:n<=2047?r+=2:n>=55296&&n<=57343?(r+=4,++t):r+=3}return r}function j(e,r,t,n){if(!(n>0))return 0;for(var a=t,o=t+n-1,i=0;i<e.length;++i){var s=e.charCodeAt(i);if(s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++i)),s<=127){if(t>=o)break;r[t++]=s}else if(s<=2047){if(t+1>=o)break;r[t++]=192|s>>6,r[t++]=128|63&s}else if(s<=65535){if(t+2>=o)break;r[t++]=224|s>>12,r[t++]=128|s>>6&63,r[t++]=128|63&s}else{if(t+3>=o)break;r[t++]=240|s>>18,r[t++]=128|s>>12&63,r[t++]=128|s>>6&63,r[t++]=128|63&s}}return r[t]=0,t-a}function N(e,r,t){var n=t>0?t:L(e)+1,a=new Array(n),o=j(e,a,0,a.length);return r&&(a.length=o),a}var H="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function Q(e,r,t){for(var n=r+t,a=r;e[a]&&!(a>=n);)++a;if(a-r>16&&e.buffer&&H)return H.decode(e.subarray(r,a));for(var o="";r<a;){var i=e[r++];if(128&i){var s=63&e[r++];if(192!=(224&i)){var u=63&e[r++];if((i=224==(240&i)?(15&i)<<12|s<<6|u:(7&i)<<18|s<<12|u<<6|63&e[r++])<65536)o+=String.fromCharCode(i);else{var l=i-65536;o+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else o+=String.fromCharCode((31&i)<<6|s)}else o+=String.fromCharCode(i)}return o}var W={ttys:[],init:function(){},shutdown:function(){},register:function(e,r){W.ttys[e]={input:[],output:[],ops:r},K.registerDevice(e,W.stream_ops)},stream_ops:{open:function(e){var r=W.ttys[e.node.rdev];if(!r)throw new K.ErrnoError(43);e.tty=r,e.seekable=!1},close:function(e){e.tty.ops.fsync(e.tty)},fsync:function(e){e.tty.ops.fsync(e.tty)},read:function(e,r,t,n,a){if(!e.tty||!e.tty.ops.get_char)throw new K.ErrnoError(60);for(var o=0,i=0;i<n;i++){var s;try{s=e.tty.ops.get_char(e.tty)}catch(e){throw new K.ErrnoError(29)}if(void 0===s&&0===o)throw new K.ErrnoError(6);if(null==s)break;o++,r[t+i]=s}return o&&(e.node.timestamp=Date.now()),o},write:function(e,r,t,n,a){if(!e.tty||!e.tty.ops.put_char)throw new K.ErrnoError(60);try{for(var o=0;o<n;o++)e.tty.ops.put_char(e.tty,r[t+o])}catch(e){throw new K.ErrnoError(29)}return n&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var r=null;if("undefined"!=typeof window&&"function"==typeof window.prompt?null!==(r=window.prompt("Input: "))&&(r+="\n"):"function"==typeof readline&&null!==(r=readline())&&(r+="\n"),!r)return null;e.input=N(r,!0)}return e.input.shift()},put_char:function(e,r){null===r||10===r?(d(Q(e.output,0)),e.output=[]):0!=r&&e.output.push(r)},fsync:function(e){e.output&&e.output.length>0&&(d(Q(e.output,0)),e.output=[])}},default_tty1_ops:{put_char:function(e,r){null===r||10===r?(p(Q(e.output,0)),e.output=[]):0!=r&&e.output.push(r)},fsync:function(e){e.output&&e.output.length>0&&(p(Q(e.output,0)),e.output=[])}}};function V(e){R()}var Y={ops_table:null,mount:function(e){return Y.createNode(null,"/",16895,0)},createNode:function(e,r,t,n){if(K.isBlkdev(t)||K.isFIFO(t))throw new K.ErrnoError(63);Y.ops_table||(Y.ops_table={dir:{node:{getattr:Y.node_ops.getattr,setattr:Y.node_ops.setattr,lookup:Y.node_ops.lookup,mknod:Y.node_ops.mknod,rename:Y.node_ops.rename,unlink:Y.node_ops.unlink,rmdir:Y.node_ops.rmdir,readdir:Y.node_ops.readdir,symlink:Y.node_ops.symlink},stream:{llseek:Y.stream_ops.llseek}},file:{node:{getattr:Y.node_ops.getattr,setattr:Y.node_ops.setattr},stream:{llseek:Y.stream_ops.llseek,read:Y.stream_ops.read,write:Y.stream_ops.write,allocate:Y.stream_ops.allocate,mmap:Y.stream_ops.mmap,msync:Y.stream_ops.msync}},link:{node:{getattr:Y.node_ops.getattr,setattr:Y.node_ops.setattr,readlink:Y.node_ops.readlink},stream:{}},chrdev:{node:{getattr:Y.node_ops.getattr,setattr:Y.node_ops.setattr},stream:K.chrdev_stream_ops}});var a=K.createNode(e,r,t,n);return K.isDir(a.mode)?(a.node_ops=Y.ops_table.dir.node,a.stream_ops=Y.ops_table.dir.stream,a.contents={}):K.isFile(a.mode)?(a.node_ops=Y.ops_table.file.node,a.stream_ops=Y.ops_table.file.stream,a.usedBytes=0,a.contents=null):K.isLink(a.mode)?(a.node_ops=Y.ops_table.link.node,a.stream_ops=Y.ops_table.link.stream):K.isChrdev(a.mode)&&(a.node_ops=Y.ops_table.chrdev.node,a.stream_ops=Y.ops_table.chrdev.stream),a.timestamp=Date.now(),e&&(e.contents[r]=a,e.timestamp=a.timestamp),a},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,r){var t=e.contents?e.contents.length:0;if(!(t>=r)){r=Math.max(r,t*(t<1048576?2:1.125)>>>0),0!=t&&(r=Math.max(r,256));var n=e.contents;e.contents=new Uint8Array(r),e.usedBytes>0&&e.contents.set(n.subarray(0,e.usedBytes),0)}},resizeFileStorage:function(e,r){if(e.usedBytes!=r)if(0==r)e.contents=null,e.usedBytes=0;else{var t=e.contents;e.contents=new Uint8Array(r),t&&e.contents.set(t.subarray(0,Math.min(r,e.usedBytes))),e.usedBytes=r}},node_ops:{getattr:function(e){var r={};return r.dev=K.isChrdev(e.mode)?e.id:1,r.ino=e.id,r.mode=e.mode,r.nlink=1,r.uid=0,r.gid=0,r.rdev=e.rdev,K.isDir(e.mode)?r.size=4096:K.isFile(e.mode)?r.size=e.usedBytes:K.isLink(e.mode)?r.size=e.link.length:r.size=0,r.atime=new Date(e.timestamp),r.mtime=new Date(e.timestamp),r.ctime=new Date(e.timestamp),r.blksize=4096,r.blocks=Math.ceil(r.size/r.blksize),r},setattr:function(e,r){void 0!==r.mode&&(e.mode=r.mode),void 0!==r.timestamp&&(e.timestamp=r.timestamp),void 0!==r.size&&Y.resizeFileStorage(e,r.size)},lookup:function(e,r){throw K.genericErrors[44]},mknod:function(e,r,t,n){return Y.createNode(e,r,t,n)},rename:function(e,r,t){if(K.isDir(e.mode)){var n;try{n=K.lookupNode(r,t)}catch(e){}if(n)for(var a in n.contents)throw new K.ErrnoError(55)}delete e.parent.contents[e.name],e.parent.timestamp=Date.now(),e.name=t,r.contents[t]=e,r.timestamp=e.parent.timestamp,e.parent=r},unlink:function(e,r){delete e.contents[r],e.timestamp=Date.now()},rmdir:function(e,r){var t=K.lookupNode(e,r);for(var n in t.contents)throw new K.ErrnoError(55);delete e.contents[r],e.timestamp=Date.now()},readdir:function(e){var r=[".",".."];for(var t in e.contents)e.contents.hasOwnProperty(t)&&r.push(t);return r},symlink:function(e,r,t){var n=Y.createNode(e,r,41471,0);return n.link=t,n},readlink:function(e){if(!K.isLink(e.mode))throw new K.ErrnoError(28);return e.link}},stream_ops:{read:function(e,r,t,n,a){var o=e.node.contents;if(a>=e.node.usedBytes)return 0;var i=Math.min(e.node.usedBytes-a,n);if(i>8&&o.subarray)r.set(o.subarray(a,a+i),t);else for(var s=0;s<i;s++)r[t+s]=o[a+s];return i},write:function(e,r,t,n,a,o){if(r.buffer===m.buffer&&(o=!1),!n)return 0;var i=e.node;if(i.timestamp=Date.now(),r.subarray&&(!i.contents||i.contents.subarray)){if(o)return i.contents=r.subarray(t,t+n),i.usedBytes=n,n;if(0===i.usedBytes&&0===a)return i.contents=r.slice(t,t+n),i.usedBytes=n,n;if(a+n<=i.usedBytes)return i.contents.set(r.subarray(t,t+n),a),n}if(Y.expandFileStorage(i,a+n),i.contents.subarray&&r.subarray)i.contents.set(r.subarray(t,t+n),a);else for(var s=0;s<n;s++)i.contents[a+s]=r[t+s];return i.usedBytes=Math.max(i.usedBytes,a+n),n},llseek:function(e,r,t){var n=r;if(1===t?n+=e.position:2===t&&K.isFile(e.node.mode)&&(n+=e.node.usedBytes),n<0)throw new K.ErrnoError(28);return n},allocate:function(e,r,t){Y.expandFileStorage(e.node,r+t),e.node.usedBytes=Math.max(e.node.usedBytes,r+t)},mmap:function(e,r,t,n,a){if(!K.isFile(e.node.mode))throw new K.ErrnoError(43);var o,i,s=e.node.contents;if(2&a||s.buffer!==m.buffer){if((t>0||t+r<s.length)&&(s=s.subarray?s.subarray(t,t+r):Array.prototype.slice.call(s,t,t+r)),i=!0,!(o=V()))throw new K.ErrnoError(48);m.set(s,o)}else i=!1,o=s.byteOffset;return{ptr:o,allocated:i}},msync:function(e,r,t,n,a){return Y.stream_ops.write(e,r,0,n,t,!1),0}}};var $=a.preloadPlugins||[];function X(e,r){var t=0;return e&&(t|=365),r&&(t|=146),t}var K={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:(e,r={})=>{if(!(e=q.resolve(e)))return{path:"",node:null};if((r=Object.assign({follow_mount:!0,recurse_count:0},r)).recurse_count>8)throw new K.ErrnoError(32);for(var t=e.split("/").filter((e=>!!e)),n=K.root,a="/",o=0;o<t.length;o++){var i=o===t.length-1;if(i&&r.parent)break;if(n=K.lookupNode(n,t[o]),a=G.join2(a,t[o]),K.isMountpoint(n)&&(!i||i&&r.follow_mount)&&(n=n.mounted.root),!i||r.follow)for(var s=0;K.isLink(n.mode);){var u=K.readlink(a);if(a=q.resolve(G.dirname(a),u),n=K.lookupPath(a,{recurse_count:r.recurse_count+1}).node,s++>40)throw new K.ErrnoError(32)}}return{path:a,node:n}},getPath:e=>{for(var r;;){if(K.isRoot(e)){var t=e.mount.mountpoint;return r?"/"!==t[t.length-1]?`${t}/${r}`:t+r:t}r=r?`${e.name}/${r}`:e.name,e=e.parent}},hashName:(e,r)=>{for(var t=0,n=0;n<r.length;n++)t=(t<<5)-t+r.charCodeAt(n)|0;return(e+t>>>0)%K.nameTable.length},hashAddNode:e=>{var r=K.hashName(e.parent.id,e.name);e.name_next=K.nameTable[r],K.nameTable[r]=e},hashRemoveNode:e=>{var r=K.hashName(e.parent.id,e.name);if(K.nameTable[r]===e)K.nameTable[r]=e.name_next;else for(var t=K.nameTable[r];t;){if(t.name_next===e){t.name_next=e.name_next;break}t=t.name_next}},lookupNode:(e,r)=>{var t=K.mayLookup(e);if(t)throw new K.ErrnoError(t,e);for(var n=K.hashName(e.id,r),a=K.nameTable[n];a;a=a.name_next){var o=a.name;if(a.parent.id===e.id&&o===r)return a}return K.lookup(e,r)},createNode:(e,r,t,n)=>{var a=new K.FSNode(e,r,t,n);return K.hashAddNode(a),a},destroyNode:e=>{K.hashRemoveNode(e)},isRoot:e=>e===e.parent,isMountpoint:e=>!!e.mounted,isFile:e=>32768==(61440&e),isDir:e=>16384==(61440&e),isLink:e=>40960==(61440&e),isChrdev:e=>8192==(61440&e),isBlkdev:e=>24576==(61440&e),isFIFO:e=>4096==(61440&e),isSocket:e=>49152==(49152&e),flagsToPermissionString:e=>{var r=["r","w","rw"][3&e];return 512&e&&(r+="w"),r},nodePermissions:(e,r)=>K.ignorePermissions||(!r.includes("r")||292&e.mode)&&(!r.includes("w")||146&e.mode)&&(!r.includes("x")||73&e.mode)?0:2,mayLookup:e=>K.nodePermissions(e,"x")||(e.node_ops.lookup?0:2),mayCreate:(e,r)=>{try{return K.lookupNode(e,r),20}catch(e){}return K.nodePermissions(e,"wx")},mayDelete:(e,r,t)=>{var n;try{n=K.lookupNode(e,r)}catch(e){return e.errno}var a=K.nodePermissions(e,"wx");if(a)return a;if(t){if(!K.isDir(n.mode))return 54;if(K.isRoot(n)||K.getPath(n)===K.cwd())return 10}else if(K.isDir(n.mode))return 31;return 0},mayOpen:(e,r)=>e?K.isLink(e.mode)?32:K.isDir(e.mode)&&("r"!==K.flagsToPermissionString(r)||512&r)?31:K.nodePermissions(e,K.flagsToPermissionString(r)):44,MAX_OPEN_FDS:4096,nextfd:()=>{for(var e=0;e<=K.MAX_OPEN_FDS;e++)if(!K.streams[e])return e;throw new K.ErrnoError(33)},getStream:e=>K.streams[e],createStream:(e,r=-1)=>(K.FSStream||(K.FSStream=function(){this.shared={}},K.FSStream.prototype={},Object.defineProperties(K.FSStream.prototype,{object:{get:function(){return this.node},set:function(e){this.node=e}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}},flags:{get:function(){return this.shared.flags},set:function(e){this.shared.flags=e}},position:{get:function(){return this.shared.position},set:function(e){this.shared.position=e}}})),e=Object.assign(new K.FSStream,e),-1==r&&(r=K.nextfd()),e.fd=r,K.streams[r]=e,e),closeStream:e=>{K.streams[e]=null},chrdev_stream_ops:{open:e=>{var r=K.getDevice(e.node.rdev);e.stream_ops=r.stream_ops,e.stream_ops.open&&e.stream_ops.open(e)},llseek:()=>{throw new K.ErrnoError(70)}},major:e=>e>>8,minor:e=>255&e,makedev:(e,r)=>e<<8|r,registerDevice:(e,r)=>{K.devices[e]={stream_ops:r}},getDevice:e=>K.devices[e],getMounts:e=>{for(var r=[],t=[e];t.length;){var n=t.pop();r.push(n),t.push.apply(t,n.mounts)}return r},syncfs:(e,r)=>{"function"==typeof e&&(r=e,e=!1),K.syncFSRequests++,K.syncFSRequests>1&&p(`warning: ${K.syncFSRequests} FS.syncfs operations in flight at once, probably just doing extra work`);var t=K.getMounts(K.root.mount),n=0;function a(e){return K.syncFSRequests--,r(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,a(e));++n>=t.length&&a(null)}t.forEach((r=>{if(!r.type.syncfs)return o(null);r.type.syncfs(r,e,o)}))},mount:(e,r,t)=>{var n,a="/"===t,o=!t;if(a&&K.root)throw new K.ErrnoError(10);if(!a&&!o){var i=K.lookupPath(t,{follow_mount:!1});if(t=i.path,n=i.node,K.isMountpoint(n))throw new K.ErrnoError(10);if(!K.isDir(n.mode))throw new K.ErrnoError(54)}var s={type:e,opts:r,mountpoint:t,mounts:[]},u=e.mount(s);return u.mount=s,s.root=u,a?K.root=u:n&&(n.mounted=s,n.mount&&n.mount.mounts.push(s)),u},unmount:e=>{var r=K.lookupPath(e,{follow_mount:!1});if(!K.isMountpoint(r.node))throw new K.ErrnoError(28);var t=r.node,n=t.mounted,a=K.getMounts(n);Object.keys(K.nameTable).forEach((e=>{for(var r=K.nameTable[e];r;){var t=r.name_next;a.includes(r.mount)&&K.destroyNode(r),r=t}})),t.mounted=null;var o=t.mount.mounts.indexOf(n);t.mount.mounts.splice(o,1)},lookup:(e,r)=>e.node_ops.lookup(e,r),mknod:(e,r,t)=>{var n=K.lookupPath(e,{parent:!0}).node,a=G.basename(e);if(!a||"."===a||".."===a)throw new K.ErrnoError(28);var o=K.mayCreate(n,a);if(o)throw new K.ErrnoError(o);if(!n.node_ops.mknod)throw new K.ErrnoError(63);return n.node_ops.mknod(n,a,r,t)},create:(e,r)=>(r=void 0!==r?r:438,r&=4095,r|=32768,K.mknod(e,r,0)),mkdir:(e,r)=>(r=void 0!==r?r:511,r&=1023,r|=16384,K.mknod(e,r,0)),mkdirTree:(e,r)=>{for(var t=e.split("/"),n="",a=0;a<t.length;++a)if(t[a]){n+="/"+t[a];try{K.mkdir(n,r)}catch(e){if(20!=e.errno)throw e}}},mkdev:(e,r,t)=>(void 0===t&&(t=r,r=438),r|=8192,K.mknod(e,r,t)),symlink:(e,r)=>{if(!q.resolve(e))throw new K.ErrnoError(44);var t=K.lookupPath(r,{parent:!0}).node;if(!t)throw new K.ErrnoError(44);var n=G.basename(r),a=K.mayCreate(t,n);if(a)throw new K.ErrnoError(a);if(!t.node_ops.symlink)throw new K.ErrnoError(63);return t.node_ops.symlink(t,n,e)},rename:(e,r)=>{var t,n,a=G.dirname(e),o=G.dirname(r),i=G.basename(e),s=G.basename(r);if(t=K.lookupPath(e,{parent:!0}).node,n=K.lookupPath(r,{parent:!0}).node,!t||!n)throw new K.ErrnoError(44);if(t.mount!==n.mount)throw new K.ErrnoError(75);var u,l=K.lookupNode(t,i),c=q.relative(e,o);if("."!==c.charAt(0))throw new K.ErrnoError(28);if("."!==(c=q.relative(r,a)).charAt(0))throw new K.ErrnoError(55);try{u=K.lookupNode(n,s)}catch(e){}if(l!==u){var f=K.isDir(l.mode),d=K.mayDelete(t,i,f);if(d)throw new K.ErrnoError(d);if(d=u?K.mayDelete(n,s,f):K.mayCreate(n,s))throw new K.ErrnoError(d);if(!t.node_ops.rename)throw new K.ErrnoError(63);if(K.isMountpoint(l)||u&&K.isMountpoint(u))throw new K.ErrnoError(10);if(n!==t&&(d=K.nodePermissions(t,"w")))throw new K.ErrnoError(d);K.hashRemoveNode(l);try{t.node_ops.rename(l,n,s)}catch(e){throw e}finally{K.hashAddNode(l)}}},rmdir:e=>{var r=K.lookupPath(e,{parent:!0}).node,t=G.basename(e),n=K.lookupNode(r,t),a=K.mayDelete(r,t,!0);if(a)throw new K.ErrnoError(a);if(!r.node_ops.rmdir)throw new K.ErrnoError(63);if(K.isMountpoint(n))throw new K.ErrnoError(10);r.node_ops.rmdir(r,t),K.destroyNode(n)},readdir:e=>{var r=K.lookupPath(e,{follow:!0}).node;if(!r.node_ops.readdir)throw new K.ErrnoError(54);return r.node_ops.readdir(r)},unlink:e=>{var r=K.lookupPath(e,{parent:!0}).node;if(!r)throw new K.ErrnoError(44);var t=G.basename(e),n=K.lookupNode(r,t),a=K.mayDelete(r,t,!1);if(a)throw new K.ErrnoError(a);if(!r.node_ops.unlink)throw new K.ErrnoError(63);if(K.isMountpoint(n))throw new K.ErrnoError(10);r.node_ops.unlink(r,t),K.destroyNode(n)},readlink:e=>{var r=K.lookupPath(e).node;if(!r)throw new K.ErrnoError(44);if(!r.node_ops.readlink)throw new K.ErrnoError(28);return q.resolve(K.getPath(r.parent),r.node_ops.readlink(r))},stat:(e,r)=>{var t=K.lookupPath(e,{follow:!r}).node;if(!t)throw new K.ErrnoError(44);if(!t.node_ops.getattr)throw new K.ErrnoError(63);return t.node_ops.getattr(t)},lstat:e=>K.stat(e,!0),chmod:(e,r,t)=>{var n;if(!(n="string"==typeof e?K.lookupPath(e,{follow:!t}).node:e).node_ops.setattr)throw new K.ErrnoError(63);n.node_ops.setattr(n,{mode:4095&r|-4096&n.mode,timestamp:Date.now()})},lchmod:(e,r)=>{K.chmod(e,r,!0)},fchmod:(e,r)=>{var t=K.getStream(e);if(!t)throw new K.ErrnoError(8);K.chmod(t.node,r)},chown:(e,r,t,n)=>{var a;if(!(a="string"==typeof e?K.lookupPath(e,{follow:!n}).node:e).node_ops.setattr)throw new K.ErrnoError(63);a.node_ops.setattr(a,{timestamp:Date.now()})},lchown:(e,r,t)=>{K.chown(e,r,t,!0)},fchown:(e,r,t)=>{var n=K.getStream(e);if(!n)throw new K.ErrnoError(8);K.chown(n.node,r,t)},truncate:(e,r)=>{if(r<0)throw new K.ErrnoError(28);var t;if(!(t="string"==typeof e?K.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new K.ErrnoError(63);if(K.isDir(t.mode))throw new K.ErrnoError(31);if(!K.isFile(t.mode))throw new K.ErrnoError(28);var n=K.nodePermissions(t,"w");if(n)throw new K.ErrnoError(n);t.node_ops.setattr(t,{size:r,timestamp:Date.now()})},ftruncate:(e,r)=>{var t=K.getStream(e);if(!t)throw new K.ErrnoError(8);if(0==(2097155&t.flags))throw new K.ErrnoError(28);K.truncate(t.node,r)},utime:(e,r,t)=>{var n=K.lookupPath(e,{follow:!0}).node;n.node_ops.setattr(n,{timestamp:Math.max(r,t)})},open:(e,r,t)=>{if(""===e)throw new K.ErrnoError(44);var n;if(t=void 0===t?438:t,t=64&(r="string"==typeof r?function(e){var r={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[e];if(void 0===r)throw new Error(`Unknown file open mode: ${e}`);return r}(r):r)?4095&t|32768:0,"object"==typeof e)n=e;else{e=G.normalize(e);try{n=K.lookupPath(e,{follow:!(131072&r)}).node}catch(e){}}var o=!1;if(64&r)if(n){if(128&r)throw new K.ErrnoError(20)}else n=K.mknod(e,t,0),o=!0;if(!n)throw new K.ErrnoError(44);if(K.isChrdev(n.mode)&&(r&=-513),65536&r&&!K.isDir(n.mode))throw new K.ErrnoError(54);if(!o){var i=K.mayOpen(n,r);if(i)throw new K.ErrnoError(i)}512&r&&!o&&K.truncate(n,0),r&=-131713;var s=K.createStream({node:n,path:K.getPath(n),flags:r,seekable:!0,position:0,stream_ops:n.stream_ops,ungotten:[],error:!1});return s.stream_ops.open&&s.stream_ops.open(s),!a.logReadFiles||1&r||(K.readFiles||(K.readFiles={}),e in K.readFiles||(K.readFiles[e]=1)),s},close:e=>{if(K.isClosed(e))throw new K.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{K.closeStream(e.fd)}e.fd=null},isClosed:e=>null===e.fd,llseek:(e,r,t)=>{if(K.isClosed(e))throw new K.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new K.ErrnoError(70);if(0!=t&&1!=t&&2!=t)throw new K.ErrnoError(28);return e.position=e.stream_ops.llseek(e,r,t),e.ungotten=[],e.position},read:(e,r,t,n,a)=>{if(n<0||a<0)throw new K.ErrnoError(28);if(K.isClosed(e))throw new K.ErrnoError(8);if(1==(2097155&e.flags))throw new K.ErrnoError(8);if(K.isDir(e.node.mode))throw new K.ErrnoError(31);if(!e.stream_ops.read)throw new K.ErrnoError(28);var o=void 0!==a;if(o){if(!e.seekable)throw new K.ErrnoError(70)}else a=e.position;var i=e.stream_ops.read(e,r,t,n,a);return o||(e.position+=i),i},write:(e,r,t,n,a,o)=>{if(n<0||a<0)throw new K.ErrnoError(28);if(K.isClosed(e))throw new K.ErrnoError(8);if(0==(2097155&e.flags))throw new K.ErrnoError(8);if(K.isDir(e.node.mode))throw new K.ErrnoError(31);if(!e.stream_ops.write)throw new K.ErrnoError(28);e.seekable&&1024&e.flags&&K.llseek(e,0,2);var i=void 0!==a;if(i){if(!e.seekable)throw new K.ErrnoError(70)}else a=e.position;var s=e.stream_ops.write(e,r,t,n,a,o);return i||(e.position+=s),s},allocate:(e,r,t)=>{if(K.isClosed(e))throw new K.ErrnoError(8);if(r<0||t<=0)throw new K.ErrnoError(28);if(0==(2097155&e.flags))throw new K.ErrnoError(8);if(!K.isFile(e.node.mode)&&!K.isDir(e.node.mode))throw new K.ErrnoError(43);if(!e.stream_ops.allocate)throw new K.ErrnoError(138);e.stream_ops.allocate(e,r,t)},mmap:(e,r,t,n,a)=>{if(0!=(2&n)&&0==(2&a)&&2!=(2097155&e.flags))throw new K.ErrnoError(2);if(1==(2097155&e.flags))throw new K.ErrnoError(2);if(!e.stream_ops.mmap)throw new K.ErrnoError(43);return e.stream_ops.mmap(e,r,t,n,a)},msync:(e,r,t,n,a)=>e.stream_ops.msync?e.stream_ops.msync(e,r,t,n,a):0,munmap:e=>0,ioctl:(e,r,t)=>{if(!e.stream_ops.ioctl)throw new K.ErrnoError(59);return e.stream_ops.ioctl(e,r,t)},readFile:(e,r={})=>{if(r.flags=r.flags||0,r.encoding=r.encoding||"binary","utf8"!==r.encoding&&"binary"!==r.encoding)throw new Error(`Invalid encoding type "${r.encoding}"`);var t,n=K.open(e,r.flags),a=K.stat(e).size,o=new Uint8Array(a);return K.read(n,o,0,a,0),"utf8"===r.encoding?t=Q(o,0):"binary"===r.encoding&&(t=o),K.close(n),t},writeFile:(e,r,t={})=>{t.flags=t.flags||577;var n=K.open(e,t.flags,t.mode);if("string"==typeof r){var a=new Uint8Array(L(r)+1),o=j(r,a,0,a.length);K.write(n,a,0,o,void 0,t.canOwn)}else{if(!ArrayBuffer.isView(r))throw new Error("Unsupported data type");K.write(n,r,0,r.byteLength,void 0,t.canOwn)}K.close(n)},cwd:()=>K.currentPath,chdir:e=>{var r=K.lookupPath(e,{follow:!0});if(null===r.node)throw new K.ErrnoError(44);if(!K.isDir(r.node.mode))throw new K.ErrnoError(54);var t=K.nodePermissions(r.node,"x");if(t)throw new K.ErrnoError(t);K.currentPath=r.path},createDefaultDirectories:()=>{K.mkdir("/tmp"),K.mkdir("/home"),K.mkdir("/home/web_user")},createDefaultDevices:()=>{K.mkdir("/dev"),K.registerDevice(K.makedev(1,3),{read:()=>0,write:(e,r,t,n,a)=>n}),K.mkdev("/dev/null",K.makedev(1,3)),W.register(K.makedev(5,0),W.default_tty_ops),W.register(K.makedev(6,0),W.default_tty1_ops),K.mkdev("/dev/tty",K.makedev(5,0)),K.mkdev("/dev/tty1",K.makedev(6,0));var e=new Uint8Array(1024),r=0,t=()=>(0===r&&(r=D(e).byteLength),e[--r]);K.createDevice("/dev","random",t),K.createDevice("/dev","urandom",t),K.mkdir("/dev/shm"),K.mkdir("/dev/shm/tmp")},createSpecialDirectories:()=>{K.mkdir("/proc");var e=K.mkdir("/proc/self");K.mkdir("/proc/self/fd"),K.mount({mount:()=>{var r=K.createNode(e,"fd",16895,73);return r.node_ops={lookup:(e,r)=>{var t=+r,n=K.getStream(t);if(!n)throw new K.ErrnoError(8);var a={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:()=>n.path}};return a.parent=a,a}},r}},{},"/proc/self/fd")},createStandardStreams:()=>{a.stdin?K.createDevice("/dev","stdin",a.stdin):K.symlink("/dev/tty","/dev/stdin"),a.stdout?K.createDevice("/dev","stdout",null,a.stdout):K.symlink("/dev/tty","/dev/stdout"),a.stderr?K.createDevice("/dev","stderr",null,a.stderr):K.symlink("/dev/tty1","/dev/stderr"),K.open("/dev/stdin",0),K.open("/dev/stdout",1),K.open("/dev/stderr",1)},ensureErrnoError:()=>{K.ErrnoError||(K.ErrnoError=function(e,r){this.name="ErrnoError",this.node=r,this.setErrno=function(e){this.errno=e},this.setErrno(e),this.message="FS error"},K.ErrnoError.prototype=new Error,K.ErrnoError.prototype.constructor=K.ErrnoError,[44].forEach((e=>{K.genericErrors[e]=new K.ErrnoError(e),K.genericErrors[e].stack="<generic error, no stack>"})))},staticInit:()=>{K.ensureErrnoError(),K.nameTable=new Array(4096),K.mount(Y,{},"/"),K.createDefaultDirectories(),K.createDefaultDevices(),K.createSpecialDirectories(),K.filesystems={MEMFS:Y}},init:(e,r,t)=>{K.init.initialized=!0,K.ensureErrnoError(),a.stdin=e||a.stdin,a.stdout=r||a.stdout,a.stderr=t||a.stderr,K.createStandardStreams()},quit:()=>{K.init.initialized=!1;for(var e=0;e<K.streams.length;e++){var r=K.streams[e];r&&K.close(r)}},findObject:(e,r)=>{var t=K.analyzePath(e,r);return t.exists?t.object:null},analyzePath:(e,r)=>{try{e=(n=K.lookupPath(e,{follow:!r})).path}catch(e){}var t={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var n=K.lookupPath(e,{parent:!0});t.parentExists=!0,t.parentPath=n.path,t.parentObject=n.node,t.name=G.basename(e),n=K.lookupPath(e,{follow:!r}),t.exists=!0,t.path=n.path,t.object=n.node,t.name=n.node.name,t.isRoot="/"===n.path}catch(e){t.error=e.errno}return t},createPath:(e,r,t,n)=>{e="string"==typeof e?e:K.getPath(e);for(var a=r.split("/").reverse();a.length;){var o=a.pop();if(o){var i=G.join2(e,o);try{K.mkdir(i)}catch(e){}e=i}}return i},createFile:(e,r,t,n,a)=>{var o=G.join2("string"==typeof e?e:K.getPath(e),r),i=X(n,a);return K.create(o,i)},createDataFile:(e,r,t,n,a,o)=>{var i=r;e&&(e="string"==typeof e?e:K.getPath(e),i=r?G.join2(e,r):e);var s=X(n,a),u=K.create(i,s);if(t){if("string"==typeof t){for(var l=new Array(t.length),c=0,f=t.length;c<f;++c)l[c]=t.charCodeAt(c);t=l}K.chmod(u,146|s);var d=K.open(u,577);K.write(d,t,0,t.length,0,o),K.close(d),K.chmod(u,s)}return u},createDevice:(e,r,t,n)=>{var a=G.join2("string"==typeof e?e:K.getPath(e),r),o=X(!!t,!!n);K.createDevice.major||(K.createDevice.major=64);var i=K.makedev(K.createDevice.major++,0);return K.registerDevice(i,{open:e=>{e.seekable=!1},close:e=>{n&&n.buffer&&n.buffer.length&&n(10)},read:(e,r,n,a,o)=>{for(var i=0,s=0;s<a;s++){var u;try{u=t()}catch(e){throw new K.ErrnoError(29)}if(void 0===u&&0===i)throw new K.ErrnoError(6);if(null==u)break;i++,r[n+s]=u}return i&&(e.node.timestamp=Date.now()),i},write:(e,r,t,a,o)=>{for(var i=0;i<a;i++)try{n(r[t+i])}catch(e){throw new K.ErrnoError(29)}return a&&(e.node.timestamp=Date.now()),i}}),K.mkdev(a,o,i)},forceLoadFile:e=>{if(e.isDevice||e.isFolder||e.link||e.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!o)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=N(o(e.url),!0),e.usedBytes=e.contents.length}catch(e){throw new K.ErrnoError(29)}},createLazyFile:(e,r,t,n,a)=>{function o(){this.lengthKnown=!1,this.chunks=[]}var i;if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var r=e%this.chunkSize,t=e/this.chunkSize|0;return this.getter(t)[r]}},o.prototype.setDataGetter=function(e){this.getter=e},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",t,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+t+". Status: "+e.status);var r,n=Number(e.getResponseHeader("Content-length")),a=(r=e.getResponseHeader("Accept-Ranges"))&&"bytes"===r,o=(r=e.getResponseHeader("Content-Encoding"))&&"gzip"===r,i=1048576;a||(i=n);var s=this;s.setDataGetter((e=>{var r=e*i,a=(e+1)*i-1;if(a=Math.min(a,n-1),void 0===s.chunks[e]&&(s.chunks[e]=((e,r)=>{if(e>r)throw new Error("invalid range ("+e+", "+r+") or no bytes requested!");if(r>n-1)throw new Error("only "+n+" bytes available! programmer error!");var a=new XMLHttpRequest;if(a.open("GET",t,!1),n!==i&&a.setRequestHeader("Range","bytes="+e+"-"+r),a.responseType="arraybuffer",a.overrideMimeType&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.send(null),!(a.status>=200&&a.status<300||304===a.status))throw new Error("Couldn't load "+t+". Status: "+a.status);return void 0!==a.response?new Uint8Array(a.response||[]):N(a.responseText||"",!0)})(r,a)),void 0===s.chunks[e])throw new Error("doXHR failed!");return s.chunks[e]})),!o&&n||(i=n=1,n=this.getter(0).length,i=n,d("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=n,this._chunkSize=i,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";i={isDevice:!1,url:t};var s=K.createFile(e,r,i,n,a);i.contents?s.contents=i.contents:i.url&&(s.contents=null,s.url=i.url),Object.defineProperties(s,{usedBytes:{get:function(){return this.contents.length}}});var u={};function l(e,r,t,n,a){var o=e.node.contents;if(a>=o.length)return 0;var i=Math.min(o.length-a,n);if(o.slice)for(var s=0;s<i;s++)r[t+s]=o[a+s];else for(s=0;s<i;s++)r[t+s]=o.get(a+s);return i}return Object.keys(s.stream_ops).forEach((e=>{var r=s.stream_ops[e];u[e]=function(){return K.forceLoadFile(s),r.apply(null,arguments)}})),u.read=(e,r,t,n,a)=>(K.forceLoadFile(s),l(e,r,t,n,a)),u.mmap=(e,r,t,n,a)=>{K.forceLoadFile(s);var o=V();if(!o)throw new K.ErrnoError(48);return l(e,m,o,r,t),{ptr:o,allocated:!0}},s.stream_ops=u,s}};function Z(e,r){return e?Q(v,e,r):""}var J={DEFAULT_POLLMASK:5,calculateAt:function(e,r,t){if(G.isAbs(r))return r;var n;if(n=-100===e?K.cwd():J.getStreamFromFD(e).path,0==r.length){if(!t)throw new K.ErrnoError(44);return n}return G.join2(n,r)},doStat:function(e,r,t){try{var n=e(r)}catch(e){if(e&&e.node&&G.normalize(r)!==G.normalize(K.getPath(e.node)))return-54;throw e}h[t>>2]=n.dev,h[t+8>>2]=n.ino,h[t+12>>2]=n.mode,b[t+16>>2]=n.nlink,h[t+20>>2]=n.uid,h[t+24>>2]=n.gid,h[t+28>>2]=n.rdev,F=[n.size>>>0,(U=n.size,+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[t+40>>2]=F[0],h[t+44>>2]=F[1],h[t+48>>2]=4096,h[t+52>>2]=n.blocks;var a=n.atime.getTime(),o=n.mtime.getTime(),i=n.ctime.getTime();return F=[Math.floor(a/1e3)>>>0,(U=Math.floor(a/1e3),+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[t+56>>2]=F[0],h[t+60>>2]=F[1],b[t+64>>2]=a%1e3*1e3,F=[Math.floor(o/1e3)>>>0,(U=Math.floor(o/1e3),+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[t+72>>2]=F[0],h[t+76>>2]=F[1],b[t+80>>2]=o%1e3*1e3,F=[Math.floor(i/1e3)>>>0,(U=Math.floor(i/1e3),+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[t+88>>2]=F[0],h[t+92>>2]=F[1],b[t+96>>2]=i%1e3*1e3,F=[n.ino>>>0,(U=n.ino,+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[t+104>>2]=F[0],h[t+108>>2]=F[1],0},doMsync:function(e,r,t,n,a){if(!K.isFile(r.node.mode))throw new K.ErrnoError(43);if(2&n)return 0;var o=v.slice(e,e+t);K.msync(r,o,a,t,n)},varargs:void 0,get:function(){return J.varargs+=4,h[J.varargs-4>>2]},getStr:function(e){return Z(e)},getStreamFromFD:function(e){var r=K.getStream(e);if(!r)throw new K.ErrnoError(8);return r}};function ee(e){var r=e-f.buffer.byteLength+65535>>>16;try{return f.grow(r),w(),1}catch(e){}}function re(e){return a["_"+e]}function te(e,r,t,n,a){var o={string:e=>{var r=0;return null!=e&&0!==e&&(r=function(e){var r=L(e)+1,t=le(r);return function(e,r,t){j(e,v,r,t)}(e,t,r),t}(e)),r},array:e=>{var r,t,n=le(e.length);return r=e,t=n,m.set(r,t),n}},i=re(e),s=[],u=0;if(n)for(var l=0;l<n.length;l++){var c=o[t[l]];c?(0===u&&(u=se()),s[l]=c(n[l])):s[l]=n[l]}var f=i.apply(null,s);return function(e){return 0!==u&&ue(u),function(e){return"string"===r?Z(e):"boolean"===r?Boolean(e):e}(e)}(f)}var ne=function(e,r,t,n){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=K.nextInode++,this.name=r,this.mode=t,this.node_ops={},this.stream_ops={},this.rdev=n};Object.defineProperties(ne.prototype,{read:{get:function(){return 365==(365&this.mode)},set:function(e){e?this.mode|=365:this.mode&=-366}},write:{get:function(){return 146==(146&this.mode)},set:function(e){e?this.mode|=146:this.mode&=-147}},isFolder:{get:function(){return K.isDir(this.mode)}},isDevice:{get:function(){return K.isChrdev(this.mode)}}}),K.FSNode=ne,K.createPreloadedFile=function(e,r,t,n,a,o,s,u,l,c){var f=r?q.resolve(G.join2(e,r)):e;function d(t){function i(t){c&&c(),u||K.createDataFile(e,r,t,n,a,l),o&&o(),k()}(function(e,r,t,n){"undefined"!=typeof Browser&&Browser.init();var a=!1;return $.forEach((function(o){a||o.canHandle(r)&&(o.handle(e,r,t,n),a=!0)})),a})(t,f,i,(()=>{s&&s(),k()}))||i(t)}z(),"string"==typeof t?function(e,r,t,n){var a=n?"":`al ${e}`;i(e,(t=>{t||R(`Loading data file "${e}" failed (no arrayBuffer).`),r(new Uint8Array(t)),a&&k()}),(r=>{if(!t)throw`Loading data file "${e}" failed.`;t()})),a&&z()}(t,(e=>d(e)),s):d(t)},K.staticInit();var ae,oe={c:function(e,r,t){J.varargs=t;try{var n=J.getStreamFromFD(e);switch(r){case 0:return(a=J.get())<0?-28:K.createStream(n,a).fd;case 1:case 2:case 6:case 7:return 0;case 3:return n.flags;case 4:var a=J.get();return n.flags|=a,0;case 5:return a=J.get(),y[a+0>>1]=2,0;case 16:case 8:default:return-28;case 9:return 28,h[ie()>>2]=28,-1}}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return-e.errno}},g:function(e,r,t){J.varargs=t;try{var n=J.getStreamFromFD(e);switch(r){case 21509:case 21505:case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:case 21523:case 21524:return n.tty?0:-59;case 21519:if(!n.tty)return-59;var a=J.get();return h[a>>2]=0,0;case 21520:return n.tty?-28:-59;case 21531:return a=J.get(),K.ioctl(n,r,a);default:return-28}}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return-e.errno}},h:function(e,r,t,n){J.varargs=n;try{r=J.getStr(r),r=J.calculateAt(e,r);var a=n?J.get():0;return K.open(r,t,a).fd}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return-e.errno}},i:function(e,r,t){v.copyWithin(e,r,r+t)},e:function(e){var r=v.length,t=2147483648;if((e>>>=0)>t)return!1;for(var n,a=1;a<=4;a*=2){var o=r*(1+.2/a);if(o=Math.min(o,e+100663296),ee(Math.min(t,(n=Math.max(e,o))+(65536-n%65536)%65536)))return!0}return!1},a:function(e){try{var r=J.getStreamFromFD(e);return K.close(r),0}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return e.errno}},f:function(e,r,t,n){try{var a=function(e,r,t,n){for(var a=0,o=0;o<t;o++){var i=b[r>>2],s=b[r+4>>2];r+=8;var u=K.read(e,m,i,s,n);if(u<0)return-1;if(a+=u,u<s)break;void 0!==n&&(n+=u)}return a}(J.getStreamFromFD(e),r,t);return b[n>>2]=a,0}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return e.errno}},d:function(e,r,t,n,a){try{var o=(u=t)+2097152>>>0<4194305-!!(s=r)?(s>>>0)+4294967296*u:NaN;if(isNaN(o))return 61;var i=J.getStreamFromFD(e);return K.llseek(i,o,n),F=[i.position>>>0,(U=i.position,+Math.abs(U)>=1?U>0?+Math.floor(U/4294967296)>>>0:~~+Math.ceil((U-+(~~U>>>0))/4294967296)>>>0:0)],h[a>>2]=F[0],h[a+4>>2]=F[1],i.getdents&&0===o&&0===n&&(i.getdents=null),0}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return e.errno}var s,u},b:function(e,r,t,n){try{var a=function(e,r,t,n){for(var a=0,o=0;o<t;o++){var i=b[r>>2],s=b[r+4>>2];r+=8;var u=K.write(e,m,i,s,n);if(u<0)return-1;a+=u,void 0!==n&&(n+=u)}return a}(J.getStreamFromFD(e),r,t);return b[n>>2]=a,0}catch(e){if(void 0===K||"ErrnoError"!==e.name)throw e;return e.errno}}},ie=(function(){var e,r,n,o,i={a:oe};function s(e,r){var t,n=e.exports;return a.asm=n,f=a.asm.j,w(),a.asm.n,t=a.asm.k,E.unshift(t),k(),n}if(z(),a.instantiateWasm)try{return a.instantiateWasm(i,s)}catch(e){p("Module.instantiateWasm callback failed with error: "+e),t(e)}(e=c,r=M,n=i,o=function(e){s(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||T(r)||"function"!=typeof fetch?O(r,n,o):fetch(r,{credentials:"same-origin"}).then((e=>WebAssembly.instantiateStreaming(e,n).then(o,(function(e){return p("wasm streaming compile failed: "+e),p("falling back to ArrayBuffer instantiation"),O(r,n,o)}))))).catch(t)}(),a._hdrToFloats=function(){return(a._hdrToFloats=a.asm.l).apply(null,arguments)},a._malloc=function(){return(a._malloc=a.asm.m).apply(null,arguments)},function(){return(ie=a.asm.o).apply(null,arguments)}),se=function(){return(se=a.asm.p).apply(null,arguments)},ue=function(){return(ue=a.asm.q).apply(null,arguments)},le=function(){return(le=a.asm.r).apply(null,arguments)};function ce(){function e(){ae||(ae=!0,a.calledRun=!0,g||(a.noFSInit||K.init.initialized||K.init(),K.ignorePermissions=!1,W.init(),I(E),r(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)e=a.postRun.shift(),S.unshift(e);var e;I(S)}()))}P>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)e=a.preRun.shift(),x.unshift(e);var e;I(x)}(),P>0||(a.setStatus?(a.setStatus("Running..."),setTimeout((function(){setTimeout((function(){a.setStatus("")}),1),e()}),1)):e()))}if(a.ccall=te,a.cwrap=function(e,r,t,n){var a=!t||t.every((e=>"number"===e||"boolean"===e));return"string"!==r&&a&&!n?re(e):function(){return te(e,r,t,arguments)}},A=function e(){ae||ce(),ae||(A=e)},a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return ce(),e.ready});"object"==typeof exports?e.exports=a:"function"==typeof define&&t.amdO?define([],(function(){return a})):"object"==typeof exports&&(exports.hdrToFloats=a)}},r={};function t(n){var a=r[n];if(void 0!==a)return a.exports;var o=r[n]={id:n,loaded:!1,exports:{}};return e[n](o,o.exports,t),o.loaded=!0,o.exports}t.amdO={},t.d=(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),t.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var r=t.g.document;if(!e&&r&&(r.currentScript&&(e=r.currentScript.src),!e)){var n=r.getElementsByTagName("script");if(n.length)for(var a=n.length-1;a>-1&&!e;)e=n[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),(()=>{var e=t(12);const r=t.p+"1dbbe3b15f012401f122d7396d5c9802.wasm",n=(0,e.h)({locateFile:e=>e.endsWith(".wasm")?r:e});async function a(e){const r=Math.floor(e.length/9),t=await n;var a=t._malloc(9*r*4);t.HEAP8.set(new Int8Array(new Float32Array(e).buffer),a);const o=document.createElement("div");o.style.width="100%",o.style.height="100%",o.style.position="absolute",o.style.background="rgba(60, 60, 60, .5)",o.style["z-index"]=100,o.style.display="flex",o.style.alignItems="center",o.style["justify-content"]="center";const i=document.createElement("div");i.innerHTML="building bvh...",i.style["font-family"]="'Roboto', sans-serif",i.style["font-size"]="15px",i.style.color="#cccccc",i.style.cursor="default",o.appendChild(i),document.body.appendChild(o),await new Promise((e=>setTimeout(e,20))),t.ccall("bvhbuild","number",["number","number"],[r,a]);const s=new Int32Array(t.HEAP8.buffer,a,4),u=new Float32Array(t.HEAP8.buffer,s[1],16*s[0]),l=new Float32Array(t.HEAP8.buffer,s[3],16*s[2]);let c=1e11,f=1e11,d=1e11,p=-1e11,m=-1e11,v=-1e11;const y=3*r;for(var h=0;h<y;h++)c=Math.min(c,e[3*h+0]),f=Math.min(f,e[3*h+1]),d=Math.min(d,e[3*h+2]),p=Math.max(p,e[3*h+0]),m=Math.max(m,e[3*h+1]),v=Math.max(v,e[3*h+2]);return o.remove(),{bvhbuffer:u,tribuffer:l,bounds:{min:{x:c,y:f,z:d},max:{x:p,y:m,z:v}}}}var o=t(698);const i=t.p+"02415db87076fc633fbc4470b9aed4df.wasm",s=(0,o.Y)({locateFile:e=>e.endsWith(".wasm")?i:e});function u(e,r,t,n){const a=new Float32Array(r.length);a.set(r);const o=new Float32Array(t.length);o.set(t),e.meshes.push({bounds:n,bvh:a,tri:o})}function l(e,r){return r>=e.meshes.length?(console.error("in add object: mesh does not exist"),!1):(e.objects.push({mesh:r,material:0,transforms:{position:{x:0,y:0,z:0},scale:1,rotation:{x:0,y:0,z:0}}}),e.didChange=!0,!0)}function c(e,r){for(var t in e.objects=[],r)l(e,Math.min(r[t].mesh,e.meshes.length-1)),e.objects[t].material=r[t].material,e.objects[t].transforms={position:{x:r[t].position[0],y:r[t].position[1],z:r[t].position[2]},scale:r[t].scale,rotation:{x:r[t].rotation[0],y:r[t].rotation[1],z:r[t].rotation[2]}}}function f(e){if(e.bounds=p(e.objs),1==e.objs.length)return;let r=m(e.objs,"x"),t=m(e.objs,"y"),n=m(e.objs,"z"),a=Math.min(Math.min(r.sah,t.sah),n.sah),o=[],i=[];if(r==a)for(let t=0;t<e.objs.length;t++)e.objs[t].centroid.x<=r.split?o.push(e.objs[t]):i.push(e.objs[t]);else if(t==a)for(let r=0;r<e.objs.length;r++)e.objs[r].centroid.y<=t.split?o.push(e.objs[r]):i.push(e.objs[r]);else for(let r=0;r<e.objs.length;r++)e.objs[r].centroid.z<=n.split?o.push(e.objs[r]):i.push(e.objs[r]);0==o.length?(console.error("note - same position in costruction?"),o.push(i.pop())):0==i.length&&(console.error("note - same position in construction?"),i.push(o.pop())),e.objs=[],e.left={objs:o},e.right={objs:i},f(e.left),f(e.right)}function d(e){let r=[];for(let n=0;n<e.objects.length;n++){let a=e.objects[n].transforms.scale,o=e.objects[n].transforms.position,i=e.objects[n].transforms.rotation,s=e.meshes[e.objects[n].mesh].bounds,u=s.min,l=s.max;const c=[[u.x*a,u.y*a,u.z*a],[l.x*a,u.y*a,u.z*a],[l.x*a,l.y*a,u.z*a],[u.x*a,l.y*a,u.z*a],[u.x*a,u.y*a,l.z*a],[l.x*a,u.y*a,l.z*a],[l.x*a,l.y*a,l.z*a],[u.x*a,l.y*a,l.z*a]],f=Math.cos(i.x),d=Math.sin(i.x),p=Math.cos(i.y),m=Math.sin(i.y),v=Math.cos(i.z),y=Math.sin(i.z);for(var t=0;t<8;t++)c[t]=[c[t][0],c[t][1]*f-c[t][2]*d,c[t][1]*d+c[t][2]*f],c[t]=[c[t][2]*m+c[t][0]*p,c[t][1],c[t][2]*p-c[t][0]*m],c[t]=[c[t][0]*v-c[t][1]*y,c[t][0]*y+c[t][1]*v,c[t][2]];const h={x:c[0][0],y:c[0][1],z:c[0][2]},b={x:c[0][0],y:c[0][1],z:c[0][2]};for(t=1;t<8;t++)h.x=Math.min(h.x,c[t][0]),h.y=Math.min(h.y,c[t][1]),h.z=Math.min(h.z,c[t][2]),b.x=Math.max(b.x,c[t][0]),b.y=Math.max(b.y,c[t][1]),b.z=Math.max(b.z,c[t][2]);r.push({min:{x:o.x+h.x,y:o.y+h.y,z:o.z+h.z},max:{x:o.x+b.x,y:o.y+b.y,z:o.z+b.z},object:e.objects[n]});let g=r[r.length-1];g.centroid={x:.5*(g.min.x+g.max.x),y:.5*(g.min.y+g.max.y),z:.5*(g.min.z+g.max.z)}}if(0==r.length){let e=new ArrayBuffer(64),r=new DataView(e);const t=0;return r.setUint32(t+0,0,!0),r.setUint32(t+4,0,!0),r.setUint32(t+8,0,!0),r.setUint32(t+12,0,!0),r.setUint32(t+16,0,!0),r.setUint32(t+20,0,!0),r.setUint32(t+24,0,!0),r.setUint32(t+28,99,!0),r.setUint32(t+32,0,!0),r.setUint32(t+36,0,!0),r.setUint32(t+40,0,!0),r.setUint32(t+48,0,!0),r.setUint32(t+52,0,!0),r.setUint32(t+56,0,!0),{bvh:new Float32Array(e),tri:new Float32Array(e)}}let n={objs:r};f(n);let a=[];const o=e=>{let r=a.length;return a.push(e),e.left&&(o(e.left),a[r].rightIndex=o(e.right)),r};o(n);let i=[];for(let e=0;e<a.length;e++){let r={};if("rightIndex"in a[e]){let t=a[e].rightIndex;r.lmin={x:a[e+1].bounds.min.x,y:a[e+1].bounds.min.y,z:a[e+1].bounds.min.z},r.lmax={x:a[e+1].bounds.max.x,y:a[e+1].bounds.max.y,z:a[e+1].bounds.max.z},r.rmin={x:a[t].bounds.min.x,y:a[t].bounds.min.y,z:a[t].bounds.min.z},r.rmax={x:a[t].bounds.max.x,y:a[t].bounds.max.y,z:a[t].bounds.max.z},r.right=t}else r.obj=a[e].objs[0].object;i.push(r)}let s=[];for(let r=0;r<e.objects.length;r++){let t=!1;for(let n=0;n<s.length;n++)s[n]!==e.objects[r].mesh||(t=!0);t||s.push(e.objects[r].mesh)}let u=64*i.length,l={},c=0,d={};for(let r=0;r<s.length;r++)l[s[r]]=u,u+=e.meshes[s[r]].bvh.byteLength,d[s[r]]=c,c+=Math.floor(e.meshes[s[r]].tri.byteLength/64);for(let e=0;e<i.length;e++)"obj"in i[e]&&(i[e].ptr=Math.floor(l[i[e].obj.mesh]/64),i[e].trioff=d[i[e].obj.mesh]);const p=new ArrayBuffer(u),m=new DataView(p);for(let e=0;e<i.length;e++){const r=64*e,t=i[e];if("obj"in t){const e=t.obj.transforms.position,n=t.obj.transforms.rotation,a=t.obj.transforms.scale,o=t.obj.material;m.setFloat32(r+0,e.x,!0),m.setFloat32(r+4,e.y,!0),m.setFloat32(r+8,e.z,!0),m.setUint32(r+12,91234569,!0),m.setFloat32(r+16,n.x,!0),m.setFloat32(r+20,n.y,!0),m.setFloat32(r+24,n.z,!0),m.setUint32(r+28,0,!0),m.setFloat32(r+32,a,!0),m.setFloat32(r+36,a,!0),m.setFloat32(r+40,a,!0),m.setUint32(r+48,t.trioff,!0),m.setUint32(r+52,t.ptr,!0),m.setUint32(r+56,o,!0)}else m.setFloat32(r+0,t.lmin.x,!0),m.setFloat32(r+4,t.lmin.y,!0),m.setFloat32(r+8,t.lmin.z,!0),m.setUint32(r+12,t.right,!0),m.setFloat32(r+16,t.lmax.x,!0),m.setFloat32(r+20,t.lmax.y,!0),m.setFloat32(r+24,t.lmax.z,!0),m.setUint32(r+28,123456,!0),m.setFloat32(r+32,t.rmin.x,!0),m.setFloat32(r+36,t.rmin.y,!0),m.setFloat32(r+40,t.rmin.z,!0),m.setFloat32(r+48,t.rmax.x,!0),m.setFloat32(r+52,t.rmax.y,!0),m.setFloat32(r+56,t.rmax.z,!0)}const v=new ArrayBuffer(64*c);for(let r=0;r<s.length;r++)new Float32Array(p,l[s[r]],e.meshes[s[r]].bvh.length).set(e.meshes[s[r]].bvh),new Float32Array(v,64*d[s[r]],e.meshes[s[r]].tri.length).set(e.meshes[s[r]].tri);return{bvh:new Float32Array(p),tri:new Float32Array(v)}}function p(e){if(0==e.length)return{min:{x:-1e30,y:-1e30,z:-1e30},max:{x:1e30,y:1e30,z:1e30}};let r=e[0].min.x,t=e[0].min.y,n=e[0].min.z,a=e[0].max.x,o=e[0].max.y,i=e[0].max.z;for(let s=1;s<e.length;s++)r=Math.min(r,e[s].min.x),t=Math.min(t,e[s].min.y),n=Math.min(n,e[s].min.z),a=Math.max(a,e[s].max.x),o=Math.max(o,e[s].max.y),i=Math.max(i,e[s].max.z);return{min:{x:r,y:t,z:n},max:{x:a,y:o,z:i}}}function m(e,r){let t,n=999999999999;for(let a=0;a<e.length;a++)v(e,e[a].centroid[r],r)<n&&(t=e[a].centroid[r]);return{sah:n,split:t}}function v(e,r,t){let n=[],a=[];for(let o=0;o<e.length;o++)e[o].centroid[t]<=r?n.push(e[o]):a.push(e[o]);let o=p(n),i=p(a),s=o.max.x-o.min.x,u=o.max.y-o.min.y,l=o.max.z-o.min.z,c=i.max.x-i.min.x,f=i.max.y-i.min.y,d=i.max.z-i.min.z;return n.length*(s*u+u*l+s*l)+a.length*(c*f+f*d+c*d)}function y(e){let r=100,t=100,n=-1e60,a=-1e60,o=null;for(var i in e.childNodes)"window-bar"===e.childNodes[i].className&&(o=e.childNodes[i]);e.addEventListener("mousedown",(()=>{const r=document.querySelectorAll(".window");for(var t=0;t<r.length;t++)r[t].style["z-index"]=10;e.style["z-index"]=11}));let s=null;for(var i in o.childNodes)"BUTTON"===o.childNodes[i].tagName&&(s=o.childNodes[i]);s.onclick=()=>{e.style.display="none"},new ResizeObserver((()=>{-1e60!=n&&-1e60!=a&&(r=window.innerWidth/2+n,t=window.innerHeight/2+a,r=h(r,0,window.innerWidth-e.offsetWidth),t=h(t,0,window.innerHeight-e.offsetHeight),e.style.left=r+"px",e.style.top=t+"px")})).observe(document.body),o.addEventListener("mousedown",(o=>{let i=o.clientX-r,s=o.clientY-t;function u(o){o.preventDefault();let u=o.clientX-i,l=o.clientY-s;u=h(u,0,window.innerWidth-e.offsetWidth),l=h(l,0,window.innerHeight-e.offsetHeight),n=u-window.innerWidth/2,a=l-window.innerHeight/2,e.style.left=u+"px",e.style.top=l+"px",r=u,t=l}window.addEventListener("mousemove",u),window.addEventListener("mouseup",(()=>{window.removeEventListener("mousemove",u)}),{once:!0})}))}function h(e,r,t){return Math.min(Math.max(r,e),t)}function b(e){let r=null;for(var t in e.childNodes)"BUTTON"===e.childNodes[t].tagName&&(r=e.childNodes[t]);let n=!1;r.onclick=()=>{let t,a;for(var o in n=!n,r.childNodes)if("expandable-arrow-container"===r.childNodes[o].className)for(var i in r.childNodes[o].childNodes)"expandable-arrow"===r.childNodes[o].childNodes[i].className&&(t=r.childNodes[o].childNodes[i]);for(var o in e.childNodes)"expandable-content"===e.childNodes[o].className&&(a=e.childNodes[o]);n?(a.style.display="",t.id="expanded"):(a.style.display="none",t.id="")},r.onclick()}window.onload=async()=>{let e=0,r=0,t=!1;const n={camera:!0,rendersize:!1};let{getObjects:o,getMaterials:i}=function(e,r,t){const n=document.querySelectorAll(".expandable");for(let e=0;e<n.length;e++)b(n[e]);!function(e){const r=document.querySelector("#orientation-editor"),t=document.querySelector("#x"),n=document.querySelector("#y"),a=document.querySelector("#z"),o=document.querySelector("#xneg"),i=document.querySelector("#yneg"),s=document.querySelector("#zneg");let u=-Math.PI/4,l=-Math.PI/16;function c(e,r,t){const n=()=>{u=e,l=r,h()};t.addEventListener("mouseup",n),window.addEventListener("mouseup",(e=>{t.removeEventListener("mouseup",n)}),{once:!0})}t.addEventListener("mousedown",(()=>{c(Math.PI,0,t)})),o.addEventListener("mousedown",(()=>{c(0,0,o)})),n.addEventListener("mousedown",(()=>{c(1.5*Math.PI,0,n)})),i.addEventListener("mousedown",(()=>{c(Math.PI/2,0,i)})),a.addEventListener("mousedown",(()=>{c(Math.PI/2,-Math.PI/2,a)})),s.addEventListener("mousedown",(()=>{c(Math.PI/2,Math.PI/2,s)}));const f=[1,0,0],d=[0,1,0],p=[0,0,1],m=[-1,0,0],v=[0,-1,0],y=[0,0,-1];function h(){e(u,l);const r=[-Math.cos(u)*Math.cos(l),-Math.sin(u)*Math.cos(l),-Math.sin(l)],c=[Math.sin(u),-Math.cos(u),0],h=[Math.cos(u)*Math.cos(l-Math.PI/2),Math.sin(u)*Math.cos(l-Math.PI/2),Math.sin(l-Math.PI/2)],g=40,w=50,x=[b(c,f)*g+w-10,b(h,f)*g+w-10,b(r,f)],E=[b(c,d)*g+w-10,b(h,d)*g+w-10,b(r,d)],S=[b(c,p)*g+w-10,b(h,p)*g+w-10,b(r,p)],P=[b(c,m)*g+w-10,b(h,m)*g+w-10,b(r,m)],B=[b(c,v)*g+w-10,b(h,v)*g+w-10,b(r,v)],A=[b(c,y)*g+w-10,b(h,y)*g+w-10,b(r,y)];t.style.left=x[0]+"px",t.style.top=x[1]+"px",n.style.left=E[0]+"px",n.style.top=E[1]+"px",a.style.left=S[0]+"px",a.style.top=S[1]+"px",o.style.left=P[0]+"px",o.style.top=P[1]+"px",i.style.left=B[0]+"px",i.style.top=B[1]+"px",s.style.left=A[0]+"px",s.style.top=A[1]+"px",t.style["z-index"]=x[2]>=0?10:-10,n.style["z-index"]=E[2]>=0?10:-10,a.style["z-index"]=S[2]>=0?10:-10,o.style["z-index"]=P[2]>=0?10:-10,i.style["z-index"]=B[2]>=0?10:-10,s.style["z-index"]=A[2]>=0?10:-10}function b(e,r){let t=0;for(var n=0;n<3;n++)t+=e[n]*r[n];return t}h(),r.addEventListener("mousedown",(e=>{const r=e.clientX,t=e.clientY,n=u,a=l,o=e=>{e.preventDefault(),u=-.01*(e.clientX-r)+n,l=-.01*(e.clientY-t)+a,h()};document.addEventListener("mousemove",o),document.addEventListener("mouseup",(()=>{document.removeEventListener("mousemove",o)}),{once:!0})}))}(e),function(e){const r=document.querySelector("#upload-mesh");let t=1;const n=(e,r)=>{const n=document.querySelector("#meshes-list");let a=document.createElement("div");a.className="expandable",r.length>25&&(r=r.substring(0,25)+"..."),a.innerHTML=`<button class="expandable-head" style="overflow: hidden;">\n            <div class="expandable-arrow-container">\n                <div class="expandable-arrow">\n                </div>\n            </div>\n            ${r}\n        </button>\n        <div style="display: none;" class="expandable-content">\n            <div style="display: flex; flex-direction: column;">\n                <div class="editable-container" style="margin: 5px 0px 5px;">\n                    <div class="editable-name">\n                        index\n                    </div>\n                    <button class="editable-other" style="overflow: hidden;">\n                        ${t++}\n                    </button>\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px; overflow: hidden;">\n                    <div class="editable-name">\n                        triangles\n                    </div>\n                    <button class="editable-other">\n                        ${e}\n                    </button>\n                </div>\n            </div>\n        </div>`,b(a),n.appendChild(a)};r.onclick=()=>{const r=document.createElement("input");r.setAttribute("type","file"),r.click(),r.onchange=()=>{const t=r.files[0];if(null==t)return;const a=document.createElement("div");a.style.width="100%",a.style.height="100%",a.style.position="absolute",a.style.background="rgba(60, 60, 60, .5)",a.style["z-index"]=100,a.style.display="flex",a.style.alignItems="center",a.style["justify-content"]="center";const o=document.createElement("div");o.innerHTML="parsing file...",o.style["font-family"]="'Roboto', sans-serif",o.style["font-size"]="15px",o.style.color="#cccccc",o.style.cursor="default",a.appendChild(o),document.body.appendChild(a);const i=new FileReader;i.onload=r=>{const o=r.target.result;let i,s=!1;try{i=function(e,r){const t=e.split("\n");let n=[],a=null;const o=/[+-]?\d+(\.\d+)?/g;let i=[];"v"===t[0].charAt(0)&&" "===t[0].charAt(1)&&(a={faces:[],name:r});for(var s=0;s<t.length;s++){if("g"!==t[s].charAt(0)&&"o"!==t[s].charAt(0)||(null!=a&&n.push(a),a={faces:[],name:t[s].substring(2)}),"v"===t[s].charAt(0)&&" "===t[s].charAt(1)){const e=t[s].match(o).map((e=>parseFloat(e)));i.push(e)}if("f"===t[s].charAt(0)){let e=[],r=!1;for(var u=0;u<t[s].length;u++)if(r=" "===t[s].charAt(u),r&&" "!==t[s].charAt(u+1)){const r=parseInt(t[s].substring(u));isFinite(r)&&e.push(r)}a.faces.push(e)}}null!=a&&n.push(a);let l=[];for(var s in n){let e=[];const r=n[s];for(var c=0;c<r.faces.length;c++)for(u=0;u<3;u++)for(var f=0;f<3;f++)e.push(i[r.faces[c][u]-1][f]);l.push({name:r.name,tris:e})}return l}(o,t.name)}catch(e){console.error(e),s=!0}s||e(i,n),a.remove()},i.readAsText(t,"UTF-8")}}}(t);for(var a=0;a<document.querySelectorAll(".window").length;a++)y(document.querySelectorAll(".window")[a]);document.querySelector("#camera-and-film-button").onclick=()=>{document.querySelector("#camera-and-film").style.display=""},document.querySelector("#objects-button").onclick=()=>{document.querySelector("#objects").style.display=""},document.querySelector("#mesh-button").onclick=()=>{document.querySelector("#mesh").style.display=""},document.querySelector("#material-button").onclick=()=>{document.querySelector("#material").style.display=""};let o=function(e){const r=document.querySelector("#objects-list");let t=0;const n=()=>{let a=document.createElement("div");a.className="expandable object",a.id=""+t++,a.innerHTML=`<button class="expandable-head">\n            <div class="expandable-arrow-container">\n                <div class="expandable-arrow">\n                </div>\n            </div>\n            Object ${t}\n        </button>\n        <div style="display: none;" class="expandable-content">\n            <div style="display: flex; flex-direction: column;">\n                <div class="editable-container" style="margin: 5px 0px 5px">\n                    <div class="editable-name">\n                        position x\n                    </div>\n                    <input id="object-position-x" value="0" step=".5" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        position y\n                    </div>\n                    <input id="object-position-y" value="0" step=".5" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        position z\n                    </div>\n                    <input id="object-position-z" value="0" step=".5" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        scale\n                    </div>\n                    <input id="object-scale" value="1" min=".001" step=".1" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        rotation z\n                    </div>\n                    <input id="object-rotation-z" value="0" step=".1" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        mesh\n                    </div>\n                    <input id="object-mesh" value="0" min="0" step="1" type="number" class="editable-input">\n                </div>\n                <div class="editable-container" style="margin: 0px 0px 5px">\n                    <div class="editable-name">\n                        material\n                    </div>\n                    <input id="object-material" value="0" min="0" step="1" type="number" class="editable-input">\n                </div>\n            </div>\n        </div>`,b(a),r.appendChild(a),document.querySelector("#new-object").onclick=n,e.scene=!0;const o=a.querySelectorAll("input");for(var i=0;i<o.length;i++){const r=i;"number"===o[r].getAttribute("type")&&(o[r].addEventListener("keyup",(e=>{"Enter"!==e.key&&13!==e.keyCode||(e.preventDefault(),o[r].dispatchEvent(new Event("onchange")))})),o[r].addEventListener("focusout",(e=>{e.preventDefault(),o[r].dispatchEvent(new Event("onchange"))})),o[r].addEventListener("onchange",(()=>{let t=o[r].value;""!==t&&null!=t||(t=0),null!=o[r].getAttribute("min")&&(t=Math.max(o[r].getAttribute("min"),t)),null!=o[r].getAttribute("max")&&(t=Math.min(o[r].getAttribute("max"),t)),1==o[r].getAttribute("step")&&(t=Math.floor(t)),e.scene=!0,o[r].value=t})))}};return document.querySelector("#new-object").onclick=n,function(){let e=[],t=r.querySelectorAll(".object");for(var n=0;n<t.length;n++){let r={};r.position=[parseFloat(t[n].querySelector("#object-position-x").value),parseFloat(t[n].querySelector("#object-position-y").value),parseFloat(t[n].querySelector("#object-position-z").value)],r.scale=[parseFloat(t[n].querySelector("#object-scale").value)],r.mesh=[parseInt(t[n].querySelector("#object-mesh").value)],r.material=[parseInt(t[n].querySelector("#object-material").value)],r.rotation=[0,0,parseFloat(t[n].querySelector("#object-rotation-z").value*Math.PI/180)],e.push(r)}return e}}(r),i=function(e){const r=document.querySelector("#new-material"),t=document.querySelector("#materials-list");let n=0;const a=["diffuse","transmissive","mirror","glossy"];let o="";for(var i in a)o+=`<option value=${a[i]}>${a[i]}</option>`;const s=()=>{let r=document.createElement("div");r.className="expandable",r.innerHTML=`<button class="expandable-head">\n            <div class="expandable-arrow-container">\n                <div class="expandable-arrow">\n                </div>\n            </div>\n            Material ${n++}\n        </button>\n        <div style="display: none;" class="expandable-content" id="material">\n            <div style="display: flex; flex-direction: column;">\n                <div class="editable-container" style="margin: 5px 0px 5px;">\n                    <div class="editable-name">\n                        type\n                    </div>\n                    <select class="editable-other" id="type-selector">\n                        ${o}\n                    </select>\n                </div>\n            </div>\n        </div>\n        `,t.appendChild(r),b(r);const a=r.querySelector("#type-selector");a.onchange=function t(){const n=r.querySelector("#type-selector").value;let a="";switch(e.material=!0,n){case"diffuse":a=`<div style="display: flex; flex-direction: column;">\n                        <div class="editable-container" style="margin: 5px 0px 5px;">\n                            <div class="editable-name">\n                                type\n                            </div>\n                            <select class="editable-other" id="type-selector">\n                                ${o}\n                            </select>\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color R\n                            </div>\n                            <input id="color-0" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color G\n                            </div>\n                            <input id="color-1" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color B\n                            </div>\n                            <input id="color-2" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                    </div>\n                    `;break;case"transmissive":a=`<div style="display: flex; flex-direction: column;">\n                        <div class="editable-container" style="margin: 5px 0px 5px;">\n                            <div class="editable-name">\n                                type\n                            </div>\n                            <select class="editable-other" id="type-selector">\n                                ${o}\n                            </select>\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                            i.o.r.\n                            </div>\n                            <input id="ior" min="0" value="1.6" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                            volume color R\n                            </div>\n                            <input id="volume-color-0" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                            volume color G\n                            </div>\n                            <input id="volume-color-1" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                            volume color B\n                            </div>\n                            <input id="volume-color-2" min="0" value=".8" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                            volume density\n                            </div>\n                            <input id="volume-density" min="0" value="5" step="5." type="number" class="editable-input">\n                        </div>\n                    </div>\n                    `;break;case"mirror":a=`<div style="display: flex; flex-direction: column;">\n                        <div class="editable-container" style="margin: 5px 0px 5px;">\n                            <div class="editable-name">\n                                type\n                            </div>\n                            <select class="editable-other" id="type-selector">\n                                ${o}\n                            </select>\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color R\n                            </div>\n                            <input id="color-0" min="0" value="1" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color G\n                            </div>\n                            <input id="color-1" min="0" value="1" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color B\n                            </div>\n                            <input id="color-2" min="0" value="1" step=".1" type="number" class="editable-input">\n                        </div>\n                    </div>\n                    `;break;case"glossy":a=`<div style="display: flex; flex-direction: column;">\n                        <div class="editable-container" style="margin: 5px 0px 5px;">\n                            <div class="editable-name">\n                                type\n                            </div>\n                            <select class="editable-other" id="type-selector">\n                                ${o}\n                            </select>\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                i.o.r.\n                            </div>\n                            <input id="ior" min="0" value="1.5" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color R\n                            </div>\n                            <input id="color-0" min="0" value=".6" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color G\n                            </div>\n                            <input id="color-1" min="0" value=".6" step=".1" type="number" class="editable-input">\n                        </div>\n                        <div class="editable-container" style="margin: 0px 0px 5px;">\n                            <div class="editable-name">\n                                color B\n                            </div>\n                            <input id="color-2" min="0" value=".6" step=".1" type="number" class="editable-input">\n                        </div>\n                    </div>\n                    `}r.querySelector(".expandable-content").innerHTML=a;const i=r.querySelector(".expandable-content").querySelectorAll("input");for(var s=0;s<i.length;s++){const r=s;"number"===i[r].getAttribute("type")&&(i[r].addEventListener("keyup",(e=>{"Enter"!==e.key&&13!==e.keyCode||(e.preventDefault(),i[r].dispatchEvent(new Event("onchange")))})),i[r].addEventListener("focusout",(e=>{e.preventDefault(),i[r].dispatchEvent(new Event("onchange"))})),i[r].addEventListener("onchange",(()=>{let t=i[r].value;""!==t&&null!=t||(t=0),null!=i[r].getAttribute("min")&&(t=Math.max(i[r].getAttribute("min"),t)),null!=i[r].getAttribute("max")&&(t=Math.min(i[r].getAttribute("max"),t)),1==i[r].getAttribute("step")&&(t=Math.floor(t)),e.material=!0,i[r].value=t})))}const u=r.querySelector("#type-selector");u.value=n,u.onchange=t},a.onchange()};return s(),r.onclick=s,()=>{const e=t.querySelectorAll("#material"),r=[];for(var n=0;n<e.length;n++){const t={};switch(e[n].querySelector("#type-selector").value){case"diffuse":t.type="diffuse",t.color=[parseFloat(e[n].querySelector("#color-0").value),parseFloat(e[n].querySelector("#color-1").value),parseFloat(e[n].querySelector("#color-2").value)];break;case"transmissive":t.type="glass",t["absorption-color"]=[parseFloat(e[n].querySelector("#volume-color-0").value),parseFloat(e[n].querySelector("#volume-color-1").value),parseFloat(e[n].querySelector("#volume-color-2").value)],t["surface-color"]=[1,1,1],t.IOR=[parseFloat(e[n].querySelector("#ior").value)],t.density=[parseFloat(e[n].querySelector("#volume-density").value)];break;case"mirror":t.type="mirror",t.color=[parseFloat(e[n].querySelector("#color-0").value),parseFloat(e[n].querySelector("#color-1").value),parseFloat(e[n].querySelector("#color-2").value)];break;case"glossy":t.type="glossy",t.color=[parseFloat(e[n].querySelector("#color-0").value),parseFloat(e[n].querySelector("#color-1").value),parseFloat(e[n].querySelector("#color-2").value)],t["glossy-color"]=[1,1,1],t.IOR=[parseFloat(e[n].querySelector("#ior").value)]}r.push(t)}return r}}(r),s={focal:"camera",aperture:"camera",camOffsetX:"camera",camOffsetY:"camera",camOffsetZ:"camera",camDistance:"camera",renderX:"rendersize",renderY:"rendersize"};const u=document.querySelectorAll("input");for(a=0;a<u.length;a++){const e=a;"number"===u[e].getAttribute("type")&&(u[e].addEventListener("keyup",(r=>{"Enter"!==r.key&&13!==r.keyCode||(r.preventDefault(),u[e].dispatchEvent(new Event("onchange")))})),u[e].addEventListener("focusout",(r=>{r.preventDefault(),u[e].dispatchEvent(new Event("onchange"))})),u[e].addEventListener("onchange",(()=>{let t=u[e].value;""!==t&&null!=t||(t=0),null!=u[e].getAttribute("min")&&(t=Math.max(u[e].getAttribute("min"),t)),null!=u[e].getAttribute("max")&&(t=Math.min(u[e].getAttribute("max"),t)),1==u[e].getAttribute("step")&&(t=Math.floor(t)),r[s[u[e].id]]=!0,u[e].value=t})))}return{getObjects:o,getMaterials:i}}((function(n,a){e=n,r=a,t=!0}),n,(async function(e,r){for(var t in e){let n=e[t],{bvhbuffer:o,tribuffer:i,bounds:s}=await a(n.tris);u(f,o,i,s),r(Math.floor(n.tris.length/9),n.name)}}));const l=await async function(){const e=await s,r=await fetch("HDRs/outdoor0.hdr").then((e=>e.arrayBuffer()));var t=e._malloc(r.byteLength);e.HEAP8.set(new Int8Array(r),t),e.ccall("hdrToFloats","number",["number","number"],[r.byteLength,t]);const n=new Int32Array(e.HEAP8.buffer,t,3),a=new Float32Array(e.HEAP8.buffer,n[2],n[0]*n[1]*4),o=new Float32Array(new ArrayBuffer(a.byteLength));return o.set(a),{buffer:o.buffer,width:n[0],height:n[1]}}(),f={meshes:[],objects:[],didChange:!1};{let e=[],r=1,t=0;e.push(-r),e.push(-r),e.push(t),e.push(r),e.push(-r),e.push(t),e.push(-r),e.push(r),e.push(t),e.push(r),e.push(r),e.push(t),e.push(-r),e.push(r),e.push(t),e.push(r),e.push(-r),e.push(t);let{bvhbuffer:n,tribuffer:o,bounds:i}=await a(e);u(f,n,o,i)}document.querySelector("#new-object").onclick(),c(f,o());let{bvh:p,tri:m}=d(f);const v=document.querySelector("#render-result");let h=await async function(e,r,t,n){let a={};const o=await(navigator.gpu?.requestAdapter()),i=await(o?.requestDevice());if(!i)return console.error("browser does not support webGPU"),{err:!0};a.device=i;const s=e.getContext("webgpu"),u=navigator.gpu.getPreferredCanvasFormat();s.configure({device:i,format:u}),a.context=s,a.canvas=e;let{addComputePass:l,computeOutputBuffer:c,bufferInfo:f,resizeOutput:d,loadScene:p,loadMaterials:m}=function(e,r,t,n,a){let o=r[0],i=r[1],s=o*i;const u={},l=e.createShaderModule({label:"Wavefront Logic Stage Shader Module",code:'//the "logic" stage of wavefront path tracing\r\n\r\n//memory layout for uniforms\r\nstruct UBO {\r\n    screen : vec4f,\r\n    position : vec4f,//note: the a component of this stores a uint with the offset to know how many more paths to write\r\n    forward : vec4f,//note: the a component of this stores a uint with the current frame number\r\n    right : vec3f,\r\n    focal : f32,\r\n    aperture : f32\r\n};\r\n//memory layout for raycast info buffer\r\nstruct RaycastInfoBufferSegment {\r\n    position : vec4f,\r\n    direction : vec4f\r\n};\r\n//memory layout for material result buffer\r\nstruct MaterialResult {\r\n    brdfpdf : vec4f,\r\n    other : vec4u\r\n};\r\n//memory layout for a raycast result\r\nstruct RaycastResultBufferSegment {\r\n    normaldist : vec4f,\r\n    other : vec4f\r\n};\r\n\r\nconst Pi      = 3.14159265358979323846;\r\nconst InvPi   = 0.31830988618379067154;\r\nconst Inv2Pi  = 0.15915494309189533577;\r\nconst Inv4Pi  = 0.07957747154594766788;\r\nconst PiOver2 = 1.57079632679489661923;\r\nconst PiOver4 = 0.78539816339744830961;\r\nconst Sqrt2   = 1.41421356237309504880;\r\n\r\n@group(0) @binding(0) var<uniform> uniforms : UBO;\r\n@group(0) @binding(1) var<storage, read_write> raycastResultBuffer : array<RaycastResultBufferSegment>;\r\n@group(0) @binding(2) var<storage, read_write> material : array<MaterialResult>;\r\n@group(0) @binding(3) var<storage, read_write> logicBuffer : array<vec4f>;\r\n@group(0) @binding(4) var<storage, read_write> materialQueueBuffer : array<u32>;\r\n@group(0) @binding(5) var<storage, read_write> newrayQueueBuffer : array<u32>;\r\n@group(0) @binding(6) var<storage, read_write>  stageOneQueueCounts : array<atomic<u32>>;\r\n@group(0) @binding(7) var<storage, read_write> imageBuffer : array<vec4f>;\r\n@group(0) @binding(8) var iblTexture : texture_2d<f32>;\r\n@group(0) @binding(9) var<storage, read> raycastInfoBuffer : array<RaycastResultBufferSegment>;\r\n\r\nvar<workgroup> materialQueueCount : atomic<u32>;\r\nvar<workgroup> newrayQueueCount : atomic<u32>;\r\nvar<workgroup> materialQueue : array<u32, 32>;\r\nvar<workgroup> newrayQueue : array<u32, 32>;\r\nvar<workgroup> numDone : atomic<u32>;\r\n\r\n@compute @workgroup_size(32)\r\nfn main(@builtin(global_invocation_id) global_id : vec3u) {\r\n    if (global_id.x >= u32(uniforms.screen.x) * u32(uniforms.screen.y)) {\r\n        return;\r\n    }\r\n\r\n    var materialResult : MaterialResult = material[global_id.x];\r\n    var raycastResult : RaycastResultBufferSegment = raycastResultBuffer[global_id.x];\r\n    var logicValue : vec4f = logicBuffer[global_id.x];\r\n\r\n    var lastMaterialEval : bool = materialResult.other.x == bitcast<u32>(uniforms.forward.a);\r\n    var hitTri : u32 = bitcast<u32>(raycastResult.other.x);\r\n    var lastRayHit : bool = hitTri != 4294967295u;\r\n    var firstFrame = bitcast<u32>(uniforms.forward.a) == 0u;\r\n\r\n    var inputThroughput : vec3f = logicValue.xyz;\r\n    var curThroughput : vec3f = select(inputThroughput, inputThroughput * materialResult.brdfpdf.xyz, lastMaterialEval);\r\n\r\n    var newpath : bool = false;\r\n\r\n    if (firstFrame) {\r\n        imageBuffer[global_id.x] = vec4f(0.);\r\n        newpath = true;\r\n    }\r\n\r\n    if (all(curThroughput == vec3f(0.)) && !firstFrame) {\r\n        newpath = true;\r\n    }\r\n\r\n    if (!lastRayHit) {\r\n        newpath = true;\r\n    }\r\n\r\n    var q : f32 = min(max(.1, 1. - curThroughput.y), .7);\r\n    initSeed(global_id.xy);\r\n    var r2 : vec2f = rand2();\r\n    if (r2.x < q) {\r\n        if (lastRayHit) {\r\n            curThroughput = vec3f(0.);\r\n        }\r\n        newpath = true;\r\n    } else {\r\n        curThroughput = curThroughput / (1. - q);\r\n    }\r\n\r\n    var clamped = clamp(curThroughput, vec3f(0.), vec3f(10.));\r\n    if (newpath && !firstFrame && all(clamped == curThroughput)) {\r\n        var curValue : vec4f = imageBuffer[global_id.x];\r\n        var newValue = vec4f(\r\n            (curValue.xyz * curValue.a + curThroughput * getIBL(raycastInfoBuffer[global_id.x].other.xyz)) / (curValue.a + 1.),\r\n            curValue.a + 1.\r\n        );\r\n        imageBuffer[global_id.x] = newValue;\r\n    }\r\n\r\n    var done : bool = atomicAdd(&numDone, 1u) == 30u;\r\n    if (newpath) {\r\n        var writeToIndex : u32 = atomicAdd(&newrayQueueCount, 1u);\r\n        newrayQueue[writeToIndex] = global_id.x;\r\n    } else {\r\n        var writeToIndex : u32 = atomicAdd(&materialQueueCount, 1u);\r\n        materialQueue[writeToIndex] = global_id.x;\r\n    }\r\n\r\n    logicBuffer[global_id.x] = vec4f(curThroughput.xyz, logicValue.a);\r\n\r\n    if (done) {\r\n        var matCount : u32 = atomicLoad(&materialQueueCount);\r\n        var newCount : u32 = atomicLoad(&newrayQueueCount);\r\n        var newpathWriteToIndex = atomicAdd(&stageOneQueueCounts[0], newCount);\r\n        for (var i : u32 = 0u; i < newCount; i++) {\r\n            newrayQueueBuffer[newpathWriteToIndex + i] = newrayQueue[i];\r\n        }\r\n        var materialWriteToIndex = atomicAdd(&stageOneQueueCounts[1], matCount);\r\n        for (var i : u32 = 0u; i < matCount; i++) {\r\n            materialQueueBuffer[materialWriteToIndex + i] = materialQueue[i];\r\n        }\r\n    }\r\n}\r\n\r\nfn getIBL(dir : vec3f) -> vec3f {\r\n    var theta : f32 = atan(dir.y / dir.x) + Pi * .5;\r\n    if (dir.x < 0.) {\r\n        theta += Pi;\r\n    }\r\n    var phi = acos(dir.z);\r\n    var lonlat : vec2f = vec2f(theta, phi) * vec2f(Inv2Pi, InvPi);\r\n    lonlat = uniforms.screen.zw * (lonlat);\r\n    return textureLoad(iblTexture, vec2i(lonlat), 0).xyz;\r\n}\r\n\r\n//from: https://www.shadertoy.com/view/XlycWh\r\nvar<private> bSeed : f32 = 0.f;\r\n\r\nfn baseHash(p : vec2u) -> u32 {\r\n    var p2 : vec2u = 1103515245u*((p >> vec2u(1u))^(p.yx));\r\n    var h32 : u32 = 1103515245u*((p2.x)^(p2.y>>3u));\r\n    return h32^(h32 >> 16);\r\n}\r\n\r\nfn initSeed(coord : vec2u) {\r\n    bSeed = f32(baseHash(coord)) / f32(0xffffffffu) + f32(bitcast<u32>(uniforms.forward.a)) * .008;\r\n}\r\n\r\nfn rand2() -> vec2f {\r\n    var n : u32 = baseHash(bitcast<vec2u>(vec2f(bSeed + 1., bSeed + 2.)));\r\n    bSeed += 2.;\r\n    var rz : vec2u = vec2u(n, n * 48271u);\r\n    return vec2f(rz.xy & vec2u(0x7fffffffu))/f32(0x7fffffff);\r\n}'}),c=e.createShaderModule({label:"Wavefront Material Stage Shader Module",code:"//wave front path tracing material evaluation kernel\r\n\r\n//memory layout for uniforms\r\nstruct UBO {\r\n    screen : vec2f,\r\n    position : vec4f,//note: the a component of this stores a uint with the offset to know how many more paths to write\r\n    forward : vec4f,//note: the a component of this stores a uint with the current frame number\r\n    right : vec3f,\r\n    focal : f32,\r\n    aperture : f32\r\n};\r\n//memory layout for raycast info buffer\r\nstruct RaycastInfoBufferSegment {\r\n    position : vec4f,//note: the a component of this stores the index to remap this ray to a path\r\n    direction : vec4f\r\n};\r\n//memory layout for material result buffer\r\nstruct MaterialResult {\r\n    brdfpdf : vec4f,\r\n    other : vec4u\r\n};\r\n//memory layout for a raycast result\r\nstruct RaycastResultBufferSegment {\r\n    normaldist : vec4f,\r\n    other : vec4u\r\n};\r\nstruct MatParams {\r\n    param0 : vec4f,\r\n    param1 : vec4f\r\n}\r\n//memory layout for the material information\r\nstruct MaterialInfo {\r\n    matparams : array<MatParams, 32>,\r\n    mattype : array<vec4u, 8>\r\n}\r\n\r\nconst Pi      = 3.14159265358979323846;\r\nconst InvPi   = 0.31830988618379067154;\r\nconst Inv2Pi  = 0.15915494309189533577;\r\nconst Inv4Pi  = 0.07957747154594766788;\r\nconst PiOver2 = 1.57079632679489661923;\r\nconst PiOver4 = 0.78539816339744830961;\r\nconst Sqrt2   = 1.41421356237309504880;\r\n\r\n\r\n@group(0) @binding(0) var<uniform> uniforms : UBO;\r\n@group(0) @binding(1) var<storage, read_write> raycastInfoBuffer : array<RaycastInfoBufferSegment>;\r\n@group(0) @binding(2) var<storage, read_write> resultBuffer : array<MaterialResult>;\r\n@group(0) @binding(3) var<storage, read> inQueueBuffer : array<u32>;\r\n@group(0) @binding(4) var<storage, read_write> stageTwoQueueCountsBuffer : array<atomic<u32>>;\r\n@group(0) @binding(5) var<storage, read_write> raycastQueueBuffer : array<u32>;\r\n@group(0) @binding(6) var<storage, read> raycastResultBuffer : array<RaycastResultBufferSegment>;\r\n@group(0) @binding(7) var<storage, read> stageOneQueueCountBuffer : array<u32>;\r\n@group(0) @binding(8) var<uniform> materialInfo : MaterialInfo;\r\n\r\nvar<workgroup> raycastQueueCount : atomic<u32>;\r\nvar<workgroup> raycastQueue : array<u32, 32>;\r\n\r\n@compute @workgroup_size(32)\r\nfn main(@builtin(global_invocation_id) global_id : vec3u) {\r\n    if (global_id.x >= stageOneQueueCountBuffer[1]) {\r\n        return;\r\n    }\r\n\r\n    initSeed(global_id.xy);\r\n\r\n    var pathIndex = inQueueBuffer[global_id.x];\r\n\r\n    var lastRaycastResult : RaycastResultBufferSegment = raycastResultBuffer[pathIndex];\r\n    var lastRaycastStart : RaycastInfoBufferSegment = raycastInfoBuffer[pathIndex];\r\n\r\n    var wo : vec3f = -lastRaycastStart.direction.xyz;\r\n    var normal : vec3f = lastRaycastResult.normaldist.xyz;\r\n    var brdfGrazingOverPdf : vec3f = vec3f(1.);\r\n    var pdf : f32 = 1.;\r\n    var wi : vec3f = vec3f(0.);\r\n\r\n    var material : u32 = lastRaycastResult.other.z;\r\n\r\n    var mattypevec : vec4u = materialInfo.mattype[material / 4u];\r\n    var mattype : u32;\r\n    if (material % 4 == 0) {\r\n        mattype = mattypevec.x;\r\n    } else if (material % 4 == 1) {\r\n        mattype = mattypevec.y;\r\n    } else if (material % 4 == 2) {\r\n        mattype = mattypevec.z;\r\n    } else {\r\n        mattype = mattypevec.a;\r\n    }\r\n    var matparams : MatParams = materialInfo.matparams[material];\r\n\r\n    var internal : bool = false;\r\n    switch (mattype) {\r\n        case 0u: {\r\n            var albedo : vec3f = matparams.param0.xyz;\r\n            var brdf : vec3f = albedo * InvPi;\r\n            var sample : vec3f = cosineSampleHemisphere();\r\n            wi = localToWorld(sample, normal);\r\n            pdf = abs(dot(wi, normal)) * InvPi;\r\n            brdfGrazingOverPdf = brdf * abs(dot(wi, normal)) / pdf;\r\n        }\r\n        case 1u: {\r\n            var attenuationColor : vec3f = matparams.param1.xyz;\r\n            var density : f32 = matparams.param1.a;\r\n            var attenuationFactor : vec3f = vec3f(1.);\r\n\r\n            var eta : f32 = matparams.param0.a;\r\n            if (dot(normal, wo) < 0.) {\r\n                internal = true; eta = 1. / eta;\r\n                attenuationFactor = exp(-(vec3(1.) - attenuationColor) * density * lastRaycastResult.normaldist.a);\r\n            }\r\n            var R : f32 = FrDialectric(abs(dot(normal, wo)), eta);\r\n            var c2 : f32 = rand2().x;\r\n            //multiply by volume and surface absorption\r\n            brdfGrazingOverPdf *= attenuationFactor;\r\n            brdfGrazingOverPdf *= matparams.param0.xyz;\r\n            if (c2 <= R || R == -1.) {\r\n                pdf = 1.;\r\n                wi = reflect(-wo, normal);\r\n            } else {\r\n                pdf = 1.;\r\n                wi = refract(-wo, normal * select(1., -1., internal), 1. / eta);\r\n                internal = !internal;\r\n            }\r\n        }\r\n        case 2u: {\r\n            brdfGrazingOverPdf *= matparams.param0.xyz;\r\n            wi = reflect(-wo, normal);\r\n            var pdf = 1.;\r\n        }\r\n        case 3u: {\r\n            var eta : f32 = matparams.param0.a;\r\n            var R : f32 = FrDialectric(abs(dot(normal, wo)), eta);\r\n            var c2 : f32 = rand2().x;\r\n            if (c2 <= R || R == -1.) {\r\n                pdf = 1.;\r\n                wi = reflect(-wo, normal);\r\n                brdfGrazingOverPdf *= matparams.param1.xyz;\r\n            } else {\r\n                var albedo : vec3f = matparams.param0.xyz;\r\n                var brdf : vec3f = albedo * InvPi;\r\n                \r\n                var sample : vec3f = cosineSampleHemisphere();\r\n                wi = localToWorld(sample, normal);\r\n\r\n                pdf = abs(dot(wi, normal)) * InvPi;\r\n                brdfGrazingOverPdf = brdf * abs(dot(wi, normal)) / pdf;\r\n            }\r\n        }\r\n        default: {\r\n            brdfGrazingOverPdf = vec3f(1., 0., 0.);\r\n            wi = reflect(-wo, normal);\r\n        }\r\n    }\r\n\r\n    var result : MaterialResult;\r\n    result.brdfpdf = vec4f(brdfGrazingOverPdf, pdf);\r\n    result.other = vec4u(bitcast<u32>(uniforms.forward.a) + 1u, 0u, 0u, 0u);\r\n    resultBuffer[pathIndex] = result;\r\n\r\n    var newRay : RaycastInfoBufferSegment;\r\n    newRay.position = vec4f(\r\n        lastRaycastResult.normaldist.xyz * select(.00001, -.00001, internal) + lastRaycastStart.position.xyz + lastRaycastResult.normaldist.a * lastRaycastStart.direction.xyz,\r\n        1.\r\n    );\r\n    newRay.direction = vec4f(\r\n        wi, 1.\r\n    );\r\n    raycastInfoBuffer[pathIndex] = newRay;\r\n\r\n    var workgroupIndex : u32 = atomicAdd(&raycastQueueCount, 1u);\r\n    raycastQueue[workgroupIndex] = pathIndex;\r\n\r\n    if (workgroupIndex == 30u) {\r\n        var stageTwoQueueWriteToIndex = atomicAdd(&stageTwoQueueCountsBuffer[0], 32u);\r\n        for (var i : u32 = 0u; i < 32u; i += 1u) {\r\n            raycastQueueBuffer[stageTwoQueueWriteToIndex + i] = raycastQueue[i];\r\n        }\r\n    }\r\n}\r\n\r\n//from: pbrt, eta = transmit to IOR / current IOR\r\n//returns negative 1 if a reflection should be done\r\nfn FrDialectric(iCosTheta : f32, eta : f32) -> f32 {\r\n    var iSinTheta2 : f32 = max(0., 1. - iCosTheta * iCosTheta);\r\n    var tSinTheta2 : f32 = iSinTheta2 / (eta * eta);\r\n    if (tSinTheta2 >= 1.) {\r\n        return -1.;\r\n    }\r\n    var tCosTheta : f32 = sqrt(1. - tSinTheta2);\r\n\r\n    var r_par : f32 = (eta * iCosTheta - tCosTheta) / (eta * iCosTheta + tCosTheta);\r\n    var r_per : f32 = (iCosTheta - eta * tCosTheta) / (iCosTheta + eta * tCosTheta);\r\n\r\n    return (r_par * r_par + r_per * r_per) / 2.;\r\n}\r\n\r\n//converts from local (normal z-up) to world\r\nfn localToWorld(sample : vec3f, normal : vec3f) -> vec3f {\r\n    var o1 : vec3f;\r\n    if (abs(normal.x) > abs(normal.y)) {\r\n        o1 = vec3f(-normal.y, normal.x, 0.);\r\n    } else {\r\n        o1 = vec3f(0., -normal.z, normal.y);\r\n    }\r\n    o1 = normalize(o1);\r\n    var o2 : vec3f = normalize(cross(normal, o1));\r\n\r\n    return  o1 * sample.x + o2 * sample.y + normal * sample.z;\r\n}\r\n\r\n//from: pbrt\r\nfn uniformSampleDisk() -> vec2f {\r\n    var r2 : vec2f = rand2();\r\n    var r : f32 = sqrt(r2.x);\r\n    var theta : f32 = 2. * Pi * r2.y;\r\n    return vec2f(r * cos(theta), r * sin(theta));\r\n}\r\n//from: pbrt\r\nfn concentricSampleDisk() -> vec2f {\r\n    var uOffset : vec2f = rand2() * 2. - vec2f(1.);\r\n\r\n    if (uOffset.x == 0. && uOffset.y == 0.) {\r\n        return vec2f(0.);\r\n    }\r\n\r\n    var theta : f32; var r : f32;\r\n    if (abs(uOffset.x) > abs(uOffset.y)) {\r\n        r = uOffset.x;\r\n        theta = PiOver4 * (uOffset.y / uOffset.x);\r\n    } else {\r\n        r = uOffset.y;\r\n        theta = PiOver2 - PiOver4 * (uOffset.x / uOffset.y);\r\n    }\r\n    return r * vec2f(cos(theta), sin(theta));\r\n}\r\n//from: pbrt\r\nfn cosineSampleHemisphere() -> vec3f {\r\n    var d : vec2f = uniformSampleDisk();\r\n    var z : f32 = sqrt(max(0., 1. - d.x * d.x - d.y * d.y));\r\n    return vec3f(d.xy, z);\r\n}\r\n\r\n\r\n//from: https://www.shadertoy.com/view/XlycWh\r\nvar<private> bSeed : f32 = 0.f;\r\n\r\nfn baseHash(p : vec2u) -> u32 {\r\n    var p2 : vec2u = 1103515245u*((p >> vec2u(1u))^(p.yx));\r\n    var h32 : u32 = 1103515245u*((p2.x)^(p2.y>>3u));\r\n    return h32^(h32 >> 16);\r\n}\r\n\r\nfn initSeed(coord : vec2u) {\r\n    bSeed = f32(baseHash(coord)) / f32(0xffffffffu) + f32(bitcast<u32>(uniforms.forward.a)) * .008;\r\n}\r\n\r\nfn rand2() -> vec2f {\r\n    var n : u32 = baseHash(bitcast<vec2u>(vec2f(bSeed + 1., bSeed + 2.)));\r\n    bSeed += 2.;\r\n    var rz : vec2u = vec2u(n, n * 48271u);\r\n    return vec2f(rz.xy & vec2u(0x7fffffffu))/f32(0x7fffffff);\r\n}"}),f=e.createShaderModule({label:"Wavefront New Ray Stage Shader Module",code:"//wave front path tracing new ray kernel\r\n\r\n//memory layout for uniforms\r\nstruct UBO {\r\n    screen : vec2f,\r\n    position : vec4f,//note: the a component of this stores a uint with the offset to know how many more paths to write\r\n    forward : vec4f,\r\n    right : vec4f,\r\n    focal : f32,\r\n    aperture : f32\r\n};\r\n//memory layout for raycast info buffer\r\nstruct RaycastInfoBufferSegment {\r\n    position : vec4f,//note: the a component of this stores the index to remap this ray to a path\r\n    direction : vec4f\r\n};\r\n\r\nconst Pi      = 3.14159265358979323846;\r\nconst InvPi   = 0.31830988618379067154;\r\nconst Inv2Pi  = 0.15915494309189533577;\r\nconst Inv4Pi  = 0.07957747154594766788;\r\nconst PiOver2 = 1.57079632679489661923;\r\nconst PiOver4 = 0.78539816339744830961;\r\nconst Sqrt2   = 1.41421356237309504880;\r\n\r\n@group(0) @binding(0) var<uniform> uniforms : UBO;\r\n@group(0) @binding(1) var<storage, read_write> raycastInfoBuffer : array<RaycastInfoBufferSegment>;\r\n@group(0) @binding(2) var<storage, read_write> logicBuffer : array<vec4f>;\r\n@group(0) @binding(3) var<storage, read> newrayQueueBuffer : array<u32>;\r\n@group(0) @binding(4) var<storage, read_write> stageTwoQueueCountsBuffer : array<atomic<u32>>;\r\n@group(0) @binding(5) var<storage, read_write> raycastQueueBuffer : array<u32>;\r\n@group(0) @binding(6) var<storage, read> stageOneQueueCountBuffer : array<u32>;\r\n\r\nvar<workgroup> raycastQueueCount : atomic<u32>;\r\nvar<workgroup> raycastQueue : array<u32, 32>;\r\n\r\n@compute @workgroup_size(32)\r\nfn main(@builtin(global_invocation_id) global_id : vec3u) {\r\n    if (global_id.x >= stageOneQueueCountBuffer[0]) {\r\n        return;\r\n    }\r\n\r\n    //var outputIndex : u32 = (bitcast<u32>(uniforms.position.a) + global_id.x) % (u32(uniforms.screen.x) * u32(uniforms.screen.y));\r\n\r\n    var pathIndex : u32 = newrayQueueBuffer[global_id.x];\r\n    var outputIndex : u32 = pathIndex;\r\n    logicBuffer[pathIndex] = vec4f(1., 1., 1., bitcast<f32>(outputIndex));\r\n    //var stageTwoQueueWriteToIndex = atomicAdd(&stageTwoQueueCountsBuffer[0], 1u);\r\n    //raycastQueueBuffer[stageTwoQueueWriteToIndex] = pathIndex;\r\n\r\n    initSeed(global_id.xy);\r\n    var spos : vec2f = vec2f(vec2u(outputIndex % u32(uniforms.screen.x), outputIndex / u32(uniforms.screen.x)));\r\n    var r2 = rand2(); var theta = 2. * Pi * r2.x;\r\n    spos += (r2.y * .5) * (vec2f(cos(theta), sin(theta)));\r\n    var sspace : vec2f = (spos - .5 * uniforms.screen) / vec2f(uniforms.screen.y, -uniforms.screen.y);\r\n    var up : vec3f = normalize(cross(uniforms.forward.xyz, uniforms.right.xyz));\r\n    \r\n    var raycastInfo : RaycastInfoBufferSegment;\r\n    var apertureSample : vec2f = uniformSampleDisk() * uniforms.aperture;\r\n    raycastInfo.position = vec4f(uniforms.position.xyz + apertureSample.x * uniforms.right.xyz + apertureSample.y * up, 1.);\r\n    raycastInfo.direction = vec4f(\r\n        normalize(uniforms.position.xyz + uniforms.focal * normalize(uniforms.forward.xyz * 1. - uniforms.right.xyz * sspace.x + up * sspace.y) - raycastInfo.position.xyz),\r\n        -3.1415//just random packing\r\n    );\r\n\r\n    raycastInfoBuffer[pathIndex] = raycastInfo;\r\n\r\n    var workgroupIndex : u32 = atomicAdd(&raycastQueueCount, 1u);\r\n    raycastQueue[workgroupIndex] = pathIndex;\r\n\r\n    if (workgroupIndex == 30u) {\r\n        var stageTwoQueueWriteToIndex = atomicAdd(&stageTwoQueueCountsBuffer[0], 32u);\r\n        for (var i : u32 = 0u; i < 32u; i += 1u) {\r\n            raycastQueueBuffer[stageTwoQueueWriteToIndex + i] = raycastQueue[i];\r\n        }\r\n    }\r\n}\r\n\r\n//from: https://www.shadertoy.com/view/XlycWh\r\nvar<private> bSeed : f32 = 0.f;\r\n\r\nfn baseHash(p : vec2u) -> u32 {\r\n    var p2 : vec2u = 1103515245u*((p >> vec2u(1u))^(p.yx));\r\n    var h32 : u32 = 1103515245u*((p2.x)^(p2.y>>3u));\r\n    return h32^(h32 >> 16);\r\n}\r\n\r\nfn initSeed(coord : vec2u) {\r\n    bSeed = f32(baseHash(coord)) / f32(0xffffffffu) + f32(bitcast<u32>(uniforms.forward.a)) * .008;\r\n}\r\n\r\nfn rand2() -> vec2f {\r\n    var n : u32 = baseHash(bitcast<vec2u>(vec2f(bSeed + 1., bSeed + 2.)));\r\n    bSeed += 2.;\r\n    var rz : vec2u = vec2u(n, n * 48271u);\r\n    return vec2f(rz.xy & vec2u(0x7fffffffu))/f32(0x7fffffff);\r\n}\r\n//from: pbrt\r\nfn uniformSampleDisk() -> vec2f {\r\n    var r2 : vec2f = rand2();\r\n    var r : f32 = sqrt(r2.x);\r\n    var theta : f32 = 2. * Pi * r2.y;\r\n    return vec2f(r * cos(theta), r * sin(theta));\r\n}"}),d=e.createShaderModule({label:"Wavefront Ray Cast Stage Shader Module",code:"//wave front path tracing ray cast closest hit kernel\r\n\r\n//memory layout for uniforms\r\nstruct UBO {\r\n    screen : vec2f,\r\n    position : vec4f,//note: the a component of this stores a uint with the offset to know how many more paths to write\r\n    forward : vec4f,//note: the a component of this stores a uint with the current frame number\r\n    right : vec3f,\r\n    focal : f32,\r\n    aperture : f32\r\n};\r\n//memory layout for raycast info buffer\r\nstruct RaycastInfoBufferSegment {\r\n    position : vec4f,//note: the a component of this stores the index to remap this ray to a path\r\n    direction : vec4f\r\n};\r\n//memory layout for result buffer\r\nstruct RaycastResultBufferSegment {\r\n    normaldist : vec4f,\r\n    other : vec4u\r\n}\r\n//memory layout for a bvh node\r\nstruct BVHNode {\r\n    AABBLLow : vec4f,\r\n    AABBLHigh : vec4f,\r\n    AABBRLow : vec4f,\r\n    AABBRHigh : vec4f\r\n};\r\n//memory layout for a triangle primitive\r\nstruct Triangle {\r\n    v0 : vec4f,\r\n    v1 : vec4f,\r\n    v2 : vec4f,\r\n    vx : vec4f\r\n};\r\n\r\n@group(0) @binding(0) var<uniform> uniforms : UBO;\r\n@group(0) @binding(1) var<storage, read> bvh : array<BVHNode>;\r\n@group(0) @binding(2) var<storage, read> tris : array<Triangle>;\r\n@group(0) @binding(3) var<storage, read> info : array<RaycastInfoBufferSegment>;\r\n@group(0) @binding(4) var<storage, read_write> result : array<RaycastResultBufferSegment>;\r\n@group(0) @binding(5) var<storage, read> queue : array<u32>;\r\n@group(0) @binding(6) var<storage, read> stageTwoQueueCountsBuffer : array<u32>;\r\n\r\nvar<private> stack : array<u32, 64>;\r\n\r\n@compute @workgroup_size(32)\r\nfn main(@builtin(global_invocation_id) global_id : vec3u) {\r\n    if (global_id.x >= stageTwoQueueCountsBuffer[0]) {\r\n        return;\r\n    }\r\n\r\n    var writeToIndex : u32 = queue[global_id.x];\r\n    var input : RaycastInfoBufferSegment = info[writeToIndex];\r\n\r\n    var o : vec3f = input.position.xyz;\r\n    var d : vec3f = input.direction.xyz;\r\n    var hitNormal = vec3f(0.);\r\n    var stackptr : u32 = 0u;\r\n    var leftHit = 0.; var rightHit = 0.;\r\n    var maxDist = 987654321.;\r\n    var foundTri : u32 = 4294967295u;\r\n    stack[stackptr] = 0u;\r\n    stackptr += 1u;\r\n    var idx : u32 = 0u;\r\n    var primptr = 0u; var primax = 0u;\r\n    var isNew = true;\r\n    var material : u32 = 0u;\r\n\r\n    var curScale : f32 = 1.;\r\n    var curPosition : vec3f = vec3f(0.);\r\n    var curRotation = 0.;// : vec3f = vec3f(0.);\r\n    var primOffset : u32 = 0u;\r\n    var bvhOffset : u32 = 0u;\r\n    var stackCutOff : u32 = 0u;\r\n    var curMaterial : u32 = 0u;\r\n\r\n    while (stackptr != 0u) {\r\n        var node : BVHNode = bvh[idx];\r\n\r\n        //this is a leaf\r\n        if (isNew && bitcast<u32>(node.AABBLLow.a) == 0u) {\r\n            primptr = bitcast<u32>(node.AABBLLow.x) + primOffset;\r\n            primax = bitcast<u32>(node.AABBLLow.y) + primOffset;\r\n            isNew = false;\r\n        }\r\n\r\n        if (stackptr <= stackCutOff) {\r\n            //undo the object space transforms\r\n            primOffset = 0u;\r\n            bvhOffset = 0u;\r\n            curMaterial = 0u;\r\n            stackCutOff = 0u;\r\n            var c = cos(curRotation);\r\n            var s = sin(curRotation);\r\n            /*o = vec3f(\r\n                o.x,\r\n                o.y * c.x - o.z * s.x,\r\n                o.y * s.x + o.z * c.x\r\n            );\r\n            d = vec3f(\r\n                d.x,\r\n                d.y * c.x - d.z * s.x,\r\n                d.y * s.x + d.z * c.x\r\n            );\r\n            o = vec3f(\r\n                o.z * s.y + o.x * c.y,\r\n                o.y,\r\n                o.z * c.y - o.x * s.y\r\n            );\r\n            d = vec3f(\r\n                d.z * s.y + d.x * c.y,\r\n                d.y,\r\n                d.z * c.y - d.x * s.y\r\n            );*/\r\n            o = vec3f(\r\n                o.x * c - o.y * s,\r\n                o.x * s + o.y * c,\r\n                o.z\r\n            );\r\n            d = vec3f(\r\n                d.x * c - d.y * s,\r\n                d.x * s + d.y * c,\r\n                d.z\r\n            );\r\n            o *= curScale;\r\n            o += curPosition;\r\n            d = normalize(d * curScale);\r\n            curScale = 1.;\r\n            curPosition = vec3f(0.);\r\n            curRotation = 0.;//vec3f(0.);\r\n        }\r\n\r\n        if (bitcast<u32>(node.AABBLHigh.a) == 0u) {\r\n            //apply object space transforms\r\n            curPosition = node.AABBLLow.xyz;\r\n            curScale = node.AABBRLow.x;\r\n            curRotation = node.AABBLHigh.z;//node.AABBLHigh.xyz;\r\n            var offsetsmatidx : vec4u = bitcast<vec4u>(node.AABBRHigh);\r\n            o = o - curPosition;\r\n            o = o / curScale;\r\n            d = normalize(d / curScale);\r\n            //apply rotation :(\r\n            var c = cos(-curRotation);\r\n            var s = sin(-curRotation);\r\n            o = vec3f(\r\n                o.x * c - o.y * s,\r\n                o.x * s + o.y * c,\r\n                o.z\r\n            );\r\n            d = vec3f(\r\n                d.x * c - d.y * s,\r\n                d.x * s + d.y * c,\r\n                d.z\r\n            );\r\n            /*o = vec3f(\r\n                o.z * s.y + o.x * c.y,\r\n                o.y,\r\n                o.z * c.y - o.x * s.y\r\n            );\r\n            d = vec3f(\r\n                d.z * s.y + d.x * c.y,\r\n                d.y,\r\n                d.z * c.y - d.x * s.y\r\n            );\r\n            o = vec3f(\r\n                o.x,\r\n                o.y * c.x - o.z * s.x,\r\n                o.y * s.x + o.z * c.x\r\n            );\r\n            d = vec3f(\r\n                d.x,\r\n                d.y * c.x - d.z * s.x,\r\n                d.y * s.x + d.z * c.x\r\n            );*/\r\n            primOffset = offsetsmatidx.x;\r\n            bvhOffset = offsetsmatidx.y;\r\n            curMaterial = offsetsmatidx.z;\r\n            idx = offsetsmatidx.y;\r\n            stackCutOff = stackptr - 1u;\r\n            isNew = true;\r\n            continue;\r\n        }\r\n\r\n        //we need to intersect the triangle\r\n        if (primptr < primax) {\r\n            var v0 : vec3f = tris[primptr].v0.xyz;\r\n            var v1 : vec3f = tris[primptr].v1.xyz;\r\n            var v2 : vec3f = tris[primptr].v2.xyz;\r\n\r\n            var e0 : vec3f = v1 - v0;\r\n            var e1 : vec3f = v2 - v0;\r\n            var pv : vec3f = cross(d, e1);\r\n            var det : f32 = dot(e0, pv);\r\n\r\n            var tv : vec3f = o - v0;\r\n            var qv : vec3f = cross(tv, e0);\r\n\r\n            var uvt : vec4f;\r\n            uvt.x = dot(tv, pv); uvt.y = dot(d, qv); uvt.z = dot(e1, qv);\r\n            uvt = vec4f(uvt.xyz / det, uvt.w);\r\n            uvt.w = 1. - uvt.x - uvt.y;\r\n            uvt.z *= curScale;\r\n\r\n            if (all(uvt >= vec4f(0.)) && uvt.z < maxDist) {\r\n                //this triangle is hit and is the closest\r\n                maxDist = uvt.z;\r\n                foundTri = primptr;\r\n                material = curMaterial;\r\n                hitNormal = normalize(cross(e0, e1));\r\n                var c = cos(curRotation);\r\n                var s = sin(curRotation);\r\n                /*hitNormal = vec3f(\r\n                    hitNormal.x,\r\n                    hitNormal.y * c.x - hitNormal.z * s.x,\r\n                    hitNormal.y * s.x + hitNormal.z * c.x\r\n                );\r\n                hitNormal = vec3f(\r\n                    hitNormal.z * s.y + hitNormal.x * c.y,\r\n                    hitNormal.y,\r\n                    hitNormal.z * c.y - hitNormal.x * s.y\r\n                );*/\r\n                hitNormal = vec3f(\r\n                    hitNormal.x * c - hitNormal.y * s,\r\n                    hitNormal.x * s + hitNormal.y * c,\r\n                    hitNormal.z\r\n                );\r\n            }\r\n\r\n            primptr += 1u;\r\n            if (primptr >= primax) {\r\n                isNew = true;\r\n                stackptr -= 1u;\r\n                idx = stack[stackptr];\r\n            }\r\n        } else {\r\n            rightHit = AABBIntersect(node.AABBRLow.xyz, node.AABBRHigh.xyz, o, d);\r\n            leftHit = AABBIntersect(node.AABBLLow.xyz, node.AABBLHigh.xyz, o, d);\r\n\r\n            var lValid : bool = leftHit != -1e30 && curScale * leftHit <= maxDist;\r\n            var rValid : bool = rightHit != -1e30 && curScale * rightHit <= maxDist;\r\n\r\n            isNew = true;\r\n            if (lValid && rValid) {\r\n                var deferred : u32 = 0u;\r\n                \r\n                var leftIndex : u32 = idx + 1u;\r\n                var rightIndex : u32 = bitcast<u32>(node.AABBLLow.a) + bvhOffset;\r\n                if (leftHit < rightHit) {\r\n                    deferred = rightIndex;\r\n                    idx = leftIndex;\r\n                } else {\r\n                    deferred = leftIndex;\r\n                    idx = rightIndex;\r\n                }\r\n                stack[stackptr] = deferred;\r\n                stackptr += 1u;\r\n            } else if (lValid) {\r\n                //depth first packing means left node is always the next\r\n                idx = idx + 1u;\r\n            } else if (rValid) {\r\n                //otherwise right node is packed into fourth component of \r\n                idx = bitcast<u32>(node.AABBLLow.a) + bvhOffset;\r\n            } else {\r\n                stackptr -= 1u;\r\n                idx = stack[stackptr];\r\n            }\r\n        }\r\n    }\r\n\r\n    var res : RaycastResultBufferSegment;\r\n    res.normaldist = vec4f(hitNormal, maxDist);\r\n    res.other = vec4u(\r\n        u32(foundTri), bitcast<u32>(uniforms.forward.a) + 1u, material, 0u\r\n    );\r\n\r\n    result[writeToIndex] = res;\r\n};\r\n\r\n//for bvh-ray intersection\r\nfn AABBIntersect(low : vec3f, high : vec3f, o : vec3f, d : vec3f) -> f32 {\r\n    var iDir = 1. / d;\r\n    var f = (high - o) * iDir; var n = (low - o) * iDir;\r\n    var tmax = max(f, n); var tmin = min(f, n);\r\n    var t0 = max(tmin.x, max(tmin.y, tmin.z));\r\n    var t1 = min(tmax.x, min(tmax.y, tmax.z));\r\n    return select(-1e30, select(t0, -1e30, t1 < 0.), t1 >= t0);\r\n}"});u.ShaderModules={logic:l,material:c,newray:f,raycast:d};let p=32*s;const m=e.createBuffer({size:p,usage:GPUBufferUsage.STORAGE});let v=32*s;const y=e.createBuffer({size:v,usage:GPUBufferUsage.STORAGE});let h=32*s;const b=e.createBuffer({size:h,usage:GPUBufferUsage.STORAGE});let g=16*s;const w=e.createBuffer({size:g,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});let x=4*s;const E=e.createBuffer({size:x,usage:GPUBufferUsage.STORAGE}),S=e.createBuffer({size:x,usage:GPUBufferUsage.STORAGE}),P=e.createBuffer({size:x,usage:GPUBufferUsage.STORAGE}),B=e.createBuffer({size:8,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),A=e.createBuffer({size:4,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),z=e.createBuffer({size:t.byteLength,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});new Float32Array(z.getMappedRange()).set(t),z.unmap();const k=e.createBuffer({size:n.byteLength,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});new Float32Array(k.getMappedRange()).set(n),k.unmap();const R=16*Math.ceil(4.5),M=e.createBuffer({size:R,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let _=Float32Array.BYTES_PER_ELEMENT*o*i*4;const U=e.createBuffer({label:"Compute Image Buffer",size:_,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),F=e.createBuffer({label:"material buffer",size:16*Math.ceil(72),usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});u.buffers={raycastInfo:m,raycastResult:y,materialResult:b,logic:w,materialQueue:E,newrayQueue:S,raycastQueue:P,stageOneQueueCounts:B,stageTwoQueueCounts:A,bvh:z,tri:k,uniform:M,output:U,material:F};const T=e.createTexture({size:[a.width,a.height],format:"rgba32float",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});e.queue.writeTexture({texture:T},a.buffer,{bytesPerRow:16*a.width},{width:a.width,height:a.height});const C=e.createBindGroupLayout({label:"Wave Front Logic Kernel Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:8,visibility:GPUShaderStage.COMPUTE,texture:{sampleType:"unfilterable-float",viewDimension:"2d",multisampled:!1}},{binding:9,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]});let O=[{binding:0,resource:{buffer:M}},{binding:1,resource:{buffer:y}},{binding:2,resource:{buffer:b}},{binding:3,resource:{buffer:w}},{binding:4,resource:{buffer:E}},{binding:5,resource:{buffer:S}},{binding:6,resource:{buffer:B}},{binding:7,resource:{buffer:U}},{binding:8,resource:T.createView()},{binding:9,resource:{buffer:m}}];const I=e.createBindGroup({label:"Wave Front Logic Kernel Bind Group",layout:C,entries:O}),G=e.createBindGroupLayout({label:"Wave Front Material Kernel Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:8,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]});let D=[{binding:0,resource:{buffer:M}},{binding:1,resource:{buffer:m}},{binding:2,resource:{buffer:b}},{binding:3,resource:{buffer:E}},{binding:4,resource:{buffer:A}},{binding:5,resource:{buffer:P}},{binding:6,resource:{buffer:y}},{binding:7,resource:{buffer:B}},{binding:8,resource:{buffer:F}}];const q=e.createBindGroup({label:"Wave Front Material Kernel Bind Group",layout:G,entries:D}),L=e.createBindGroupLayout({label:"Wave Front New Ray Kernel Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]});let j=[{binding:0,resource:{buffer:M}},{binding:1,resource:{buffer:m}},{binding:2,resource:{buffer:w}},{binding:3,resource:{buffer:S}},{binding:4,resource:{buffer:A}},{binding:5,resource:{buffer:P}},{binding:6,resource:{buffer:B}}];const N=e.createBindGroup({label:"Wave Front New Ray Kernel Bind Group",layout:L,entries:j}),H=e.createBindGroupLayout({label:"Wave Front Raycast Kernel Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]});let Q=[{binding:0,resource:{buffer:M}},{binding:1,resource:{buffer:z}},{binding:2,resource:{buffer:k}},{binding:3,resource:{buffer:m}},{binding:4,resource:{buffer:y}},{binding:5,resource:{buffer:P}},{binding:6,resource:{buffer:A}}];const W=e.createBindGroup({label:"Wave Front Raycast Kernel Bind Group",layout:H,entries:Q});u.bindgroups={logic:{entries:O,layout:C,bg:I},material:{entries:D,layout:G,bg:q},newray:{entries:j,layout:L,bg:N},raycast:{entries:Q,layout:H,bg:W}};const V=e.createComputePipeline({label:"Wave Front Logic Kernel Pipeline",layout:e.createPipelineLayout({bindGroupLayouts:[C]}),compute:{module:l,entryPoint:"main"}}),Y=e.createComputePipeline({label:"Wave Front New Ray Kernel Pipeline",layout:e.createPipelineLayout({bindGroupLayouts:[L]}),compute:{module:f,entryPoint:"main"}}),$=e.createComputePipeline({label:"Wave Front Material Kernel Pipeline",layout:e.createPipelineLayout({bindGroupLayouts:[G]}),compute:{module:c,entryPoint:"main"}}),X=e.createComputePipeline({label:"Wave Front Ray Cast Closest Kernel Pipeline",layout:e.createPipelineLayout({bindGroupLayouts:[H]}),compute:{module:d,entryPoint:"main"}});u.pipelines={logic:V,newray:Y,material:$,raycast:X};const K=e.createBuffer({size:8,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});return u.buffers.queueCountsRead=K,{addComputePass:async e=>{const r=e.uniformValues,t=e.device;1==r.reset&&(r.frames=[0],r.reset=!1);const n=new ArrayBuffer(72),o=new DataView(n);o.setFloat32(0,r.rendersize[0],!0),o.setFloat32(4,r.rendersize[1],!0),o.setFloat32(8,a.width,!0),o.setFloat32(12,a.height,!0),o.setFloat32(16,r.position[0],!0),o.setFloat32(20,r.position[1],!0),o.setFloat32(24,r.position[2],!0),o.setUint32(28,r.pathoffset[0],!0),o.setFloat32(32,r.forward[0],!0),o.setFloat32(36,r.forward[1],!0),o.setFloat32(40,r.forward[2],!0),o.setUint32(44,r.frames[0],!0),o.setFloat32(48,r.left[0],!0),o.setFloat32(52,r.left[1],!0),o.setFloat32(56,r.left[2],!0),o.setFloat32(64,r.focal,!0),o.setFloat32(68,r.aperture,!0),t.queue.writeBuffer(u.buffers.uniform,0,n),t.queue.writeBuffer(u.buffers.stageOneQueueCounts,0,new Uint32Array([0,0])),t.queue.writeBuffer(u.buffers.stageTwoQueueCounts,0,new Uint32Array([0]));const i=t.createCommandEncoder(),l=i.beginComputePass();l.setPipeline(u.pipelines.logic),l.setBindGroup(0,u.bindgroups.logic.bg),l.dispatchWorkgroups(Math.ceil(s/32)),l.end(),i.copyBufferToBuffer(u.buffers.stageOneQueueCounts,0,u.buffers.queueCountsRead,0,8),t.queue.submit([i.finish()]),await u.buffers.queueCountsRead.mapAsync(GPUMapMode.READ);const c=u.buffers.queueCountsRead.getMappedRange();let f=new Uint32Array(c);const d=f[0],p=f[1];u.buffers.queueCountsRead.unmap();const m=t.createCommandEncoder(),v=m.beginComputePass();v.setPipeline(u.pipelines.material),v.setBindGroup(0,u.bindgroups.material.bg),v.dispatchWorkgroups(Math.ceil(p/32)),v.setPipeline(u.pipelines.newray),v.setBindGroup(0,u.bindgroups.newray.bg),v.dispatchWorkgroups(Math.ceil(d/32)),v.end(),m.copyBufferToBuffer(u.buffers.stageTwoQueueCounts,0,u.buffers.queueCountsRead,0,4),t.queue.submit([m.finish()]),await u.buffers.queueCountsRead.mapAsync(GPUMapMode.READ);const y=u.buffers.queueCountsRead.getMappedRange(),h=new Uint32Array(y)[0];u.buffers.queueCountsRead.unmap();const b=t.createCommandEncoder(),g=b.beginComputePass();g.setPipeline(u.pipelines.raycast),g.setBindGroup(0,u.bindgroups.raycast.bg),g.dispatchWorkgroups(Math.ceil(h/32)),g.end(),await t.queue.submit([b.finish()]),r.pathoffset[0]+=d,r.frames[0]++},computeOutputBuffer:U,resizeOutput:async(r,t,n,a)=>{r.uniformValues,o=t,i=n,s=o*i,a.width=o,a.height=i;let l=.95*window.innerHeight,c=l*o/i;return c>=.95*window.innerWidth&&(c=.95*window.innerWidth,l=c*i/o),document.querySelector(":root").style.setProperty("--canvas-width",c+"px"),document.querySelector(":root").style.setProperty("--canvas-height",l+"px"),u.buffers.output&&u.buffers.output.destroy(),u.buffers.output=e.createBuffer({label:"output buffer",size:o*i*16,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),p=32*s,u.buffers.raycastInfo&&u.buffers.raycastInfo.destroy(),u.buffers.raycastInfo=e.createBuffer({label:"raycast info buffer",size:p,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC}),v=32*s,u.buffers.raycastResult&&u.buffers.raycastResult.destroy(),u.buffers.raycastResult=e.createBuffer({label:"raycast result buffer",size:v,usage:GPUBufferUsage.STORAGE}),h=32*s,u.buffers.materialResult&&u.buffers.materialResult.destroy(),u.buffers.materialResult=e.createBuffer({label:"material result buffer",size:h,usage:GPUBufferUsage.STORAGE}),g=16*s,u.buffers.logic&&u.buffers.logic.destroy(),u.buffers.logic=e.createBuffer({label:"logic buffer",size:g,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),x=4*s,u.buffers.materialQueue&&u.buffers.materialQueue.destroy(),u.buffers.materialQueue=e.createBuffer({label:"material queue buffer",size:x,usage:GPUBufferUsage.STORAGE}),u.buffers.newrayQueue&&u.buffers.newrayQueue.destroy(),u.buffers.newrayQueue=e.createBuffer({label:"newray queue buffer",size:x,usage:GPUBufferUsage.STORAGE}),u.buffers.raycastQueue&&u.buffers.raycastQueue.destroy(),u.buffers.raycastQueue=e.createBuffer({label:"raycast queue buffer",size:x,usage:GPUBufferUsage.STORAGE}),u.bindgroups.logic.entries[1].resource.buffer=u.buffers.raycastResult,u.bindgroups.logic.entries[2].resource.buffer=u.buffers.materialResult,u.bindgroups.logic.entries[3].resource.buffer=u.buffers.logic,u.bindgroups.logic.entries[4].resource.buffer=u.buffers.materialQueue,u.bindgroups.logic.entries[5].resource.buffer=u.buffers.newrayQueue,u.bindgroups.logic.entries[7].resource.buffer=u.buffers.output,u.bindgroups.logic.entries[9].resource.buffer=u.buffers.raycastInfo,u.bindgroups.material.entries[1].resource.buffer=u.buffers.raycastInfo,u.bindgroups.material.entries[2].resource.buffer=u.buffers.materialResult,u.bindgroups.material.entries[3].resource.buffer=u.buffers.materialQueue,u.bindgroups.material.entries[5].resource.buffer=u.buffers.raycastQueue,u.bindgroups.material.entries[6].resource.buffer=u.buffers.raycastResult,u.bindgroups.newray.entries[1].resource.buffer=u.buffers.raycastInfo,u.bindgroups.newray.entries[2].resource.buffer=u.buffers.logic,u.bindgroups.newray.entries[3].resource.buffer=u.buffers.newrayQueue,u.bindgroups.newray.entries[5].resource.buffer=u.buffers.raycastQueue,u.bindgroups.raycast.entries[3].resource.buffer=u.buffers.raycastInfo,u.bindgroups.raycast.entries[4].resource.buffer=u.buffers.raycastResult,u.bindgroups.raycast.entries[5].resource.buffer=u.buffers.raycastQueue,u.bindgroups.logic.bg=r.device.createBindGroup({label:"Wave Front Logic Kernel Bind Group",layout:u.bindgroups.logic.layout,entries:u.bindgroups.logic.entries}),u.bindgroups.material.bg=r.device.createBindGroup({label:"Wave Front Material Kernel Bind Group",layout:u.bindgroups.material.layout,entries:u.bindgroups.material.entries}),u.bindgroups.newray.bg=r.device.createBindGroup({label:"Wave Front NewRay Kernel Bind Group",layout:u.bindgroups.newray.layout,entries:u.bindgroups.newray.entries}),u.bindgroups.raycast.bg=r.device.createBindGroup({label:"Wave Front Raycast Kernel Bind Group",layout:u.bindgroups.raycast.layout,entries:u.bindgroups.raycast.entries}),u.buffers.output},bufferInfo:u,loadScene:(r,t)=>{u.buffers.bvh&&u.buffers.bvh.destroy(),u.buffers.tri&&u.buffers.tri.destroy(),u.buffers.bvh=e.createBuffer({size:r.byteLength,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),new Float32Array(u.buffers.bvh.getMappedRange()).set(r),u.buffers.bvh.unmap(),u.buffers.tri=e.createBuffer({size:t.byteLength,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),new Float32Array(u.buffers.tri.getMappedRange()).set(t),u.buffers.tri.unmap(),u.bindgroups.raycast.entries[1].resource.buffer=u.buffers.bvh,u.bindgroups.raycast.entries[2].resource.buffer=u.buffers.tri,u.bindgroups.raycast.bg=e.createBindGroup({label:"Wave Front Raycast Kernel Bind Group",layout:u.bindgroups.raycast.layout,entries:u.bindgroups.raycast.entries})},loadMaterials:r=>{let t=new Uint32Array(32),n=new Float32Array(256);for(var a=0;a<r.length&&a<32;a++)switch(r[a].type){case"diffuse":t[a]=0,n[8*a+0]=r[a].color[0],n[8*a+1]=r[a].color[1],n[8*a+2]=r[a].color[2];break;case"glass":t[a]=1,n[8*a+0]=r[a]["surface-color"][0],n[8*a+1]=r[a]["surface-color"][1],n[8*a+2]=r[a]["surface-color"][2],n[8*a+3]=r[a].IOR[0],n[8*a+4]=r[a]["absorption-color"][0],n[8*a+5]=r[a]["absorption-color"][1],n[8*a+6]=r[a]["absorption-color"][2],n[8*a+7]=r[a].density[0];break;case"mirror":t[a]=2,n[8*a+0]=r[a].color[0],n[8*a+1]=r[a].color[1],n[8*a+2]=r[a].color[2];break;case"glossy":t[a]=3,n[8*a+0]=r[a].color[0],n[8*a+1]=r[a].color[1],n[8*a+2]=r[a].color[2],n[8*a+3]=r[a].IOR[0],n[8*a+4]=r[a]["glossy-color"][0],n[8*a+5]=r[a]["glossy-color"][1],n[8*a+6]=r[a]["glossy-color"][2];break;default:console.error("reached default in material")}const o=new ArrayBuffer(t.byteLength+n.byteLength);new Float32Array(o).set(n),new Uint32Array(o).set(t,n.byteLength/4),e.queue.writeBuffer(u.buffers.material,0,o)}}}(i,[e.width,e.height],r,t,n),{addFullScreenPass:v,resizeFullscreen:y}=function(e,r,t,n){let a=e.createBindGroupLayout({label:"Full Screen Bind Group Layout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"read-only-storage"}}]});const o=e.createShaderModule({label:"Full Screen Pass",code:"@vertex \r\nfn vs(@builtin(vertex_index) vertexIndex : u32) -> @builtin(position) vec4f {\r\n    switch(vertexIndex) {\r\n        case 0u: {\r\n            return vec4f(1., 1., 0., 1.);}\r\n        case 1u: {\r\n            return vec4f(-1., 1., 0., 1.);}\r\n        case 2u: {\r\n            return vec4f(-1., -1., 0., 1.);}\r\n        case 3u: {\r\n            return vec4f(1., -1., 0., 1.);}\r\n        case 4u: {\r\n            return vec4f(1., 1., 0., 1.);}\r\n        case 5u: {\r\n            return vec4f(-1., -1., 0., 1.);}\r\n        default: {\r\n            return vec4f(0., 0., 0., 0.);}\r\n    }\r\n}\r\n\r\nstruct Uniforms {\r\n    screenWidth : f32, screenHeight : f32\r\n}\r\n\r\n@group(0) @binding(0) var<uniform> uniforms : Uniforms;\r\n@group(0) @binding(1) var<storage, read> finalColorBuffer : array<vec4f>;\r\n\r\n@fragment \r\nfn fs(@builtin(position) fragCoord : vec4f) -> @location(0) vec4f {\r\n    var idx = u32(fragCoord.x) + u32(fragCoord.y) * u32(uniforms.screenWidth);\r\n\r\n    return vec4f(toneMap(finalColorBuffer[idx].xyz), 1.);\r\n}\r\n\r\nfn toneMap(z : vec3f) -> vec3f {\r\n    return z / vec3f(1. + dot(z, vec3f(.2126, .7152, .0722)));\r\n}\r\n\r\nfn ACESFilm(x : vec3f) -> vec3f {\r\n    var a = 2.51;\r\n    var b = 0.03;\r\n    var c = 2.43;\r\n    var d = 0.59;\r\n    var e = 0.14;\r\n    return pow((x*(a*x+b))/(x*(c*x+d)+e), vec3f(1. / 2.2));\r\n}"}),i=e.createRenderPipeline({label:"Full Screen Pipeline",layout:e.createPipelineLayout({bindGroupLayouts:[a]}),vertex:{module:o,entryPoint:"vs"},fragment:{module:o,entryPoint:"fs",targets:[{format:r}]}}),s=e.createBuffer({size:8,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});let u=e.createBindGroup({label:"Full Screen Bind Group",layout:a,entries:[{binding:0,resource:{buffer:s}},{binding:1,resource:{buffer:n}}]});const l={colorAttachments:[{view:void 0,clearValue:{r:1,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};return{addFullScreenPass:(r,t,n)=>{e.queue.writeBuffer(s,0,new Float32Array([n.uniformValues.rendersize[0],n.uniformValues.rendersize[0]])),l.colorAttachments[0].view=r.getCurrentTexture().createView();const a=t.beginRenderPass(l);a.setPipeline(i),a.setBindGroup(0,u),a.draw(6),a.end()},resizeFullscreen:r=>{u=e.createBindGroup({label:"Full Screen Bind Group",layout:a,entries:[{binding:0,resource:{buffer:s}},{binding:1,resource:{buffer:r}}]})}}}(i,u,(e.width,e.height),c);a.imageBuffer=c,a.bufferInfo=f,a.addComputePass=l,a.addFullScreenPass=v,a.loadMaterials=m,a.resize=async(e,r,t)=>{if(e*r>2001e3)return document.querySelector("#renderY").value=parseInt(t.width),void(document.querySelector("#renderY").value=parseInt(t.height));const n=await d(a,e,r,t);a.imageBuffer=n,a.uniformValues.rendersize=[e,r],y(n)},a.loadScene=p;let h=Math.cos(0),b=Math.sin(0),g=Math.cos(0),w=Math.sin(0);return a.uniformValues={rendersize:[e.width,e.height],position:[h*g*-20,b*g*-20,-20*w+4.5],forward:[h*g,b*g,w],left:[-b,h,0],focal:[5.5],aperture:[.1],frames:[0],pathoffset:[0],reset:!1},a}(v,p,m,l);function g(){const e=v.width,r=v.height;let t=.95*window.innerHeight,n=t*e/r;n>=.95*window.innerWidth&&(n=.95*window.innerWidth,t=n*r/e),document.querySelector(":root").style.setProperty("--canvas-width",n+"px"),document.querySelector(":root").style.setProperty("--canvas-height",t+"px")}g(),new ResizeObserver(g).observe(document.body);const w={download:!1,exit:!1};function x(){document.querySelector("#pause").onclick=E,document.querySelector("#pause").innerHTML="Pause Render",S()}function E(){w.exit=!0,document.querySelector("#pause").innerHTML="Start Render",document.querySelector("#pause").onclick=x}async function S(){if(w.download&&(await async function(e){const r=e.canvas,t=r.width*r.height,n=e.device.createBuffer({size:16*t,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),a=e.device.createCommandEncoder();a.copyBufferToBuffer(e.imageBuffer,0,n,0,16*t),e.device.queue.submit([a.finish()]),await n.mapAsync(GPUMapMode.READ);const o=n.getMappedRange(),i=new Float32Array(o),s=new Uint8ClampedArray(4*t);for(var u=0;u<t;u++){const e=4*u,r=255/(1+.2126*i[e+0]+.7152*i[e+1]+.0722*i[e+2]);s[e+0]=i[e+0]*r,s[e+1]=i[e+1]*r,s[e+2]=i[e+2]*r,s[e+3]=255}n.unmap(),n.destroy();const l=document.createElement("canvas"),c=l.getContext("2d");l.width=r.width,l.height=r.height;const f=c.createImageData(r.width,r.height);f.data.set(s),c.putImageData(f,0,0);var d=document.createElement("a");d.download="save.png",d.href=l.toDataURL(),d.click()}(h),w.download=!1),w.exit)w.exit=!1;else{if(n.material&&(n.material=!1,h.uniformValues.reset=!0,h.loadMaterials(i())),t||n.camera){const a=Math.cos(e),o=Math.sin(e),i=Math.cos(r),s=Math.sin(r),u=parseFloat(document.querySelector("#camDistance").value),l=parseFloat(document.querySelector("#camOffsetX").value),c=parseFloat(document.querySelector("#camOffsetY").value),f=parseFloat(document.querySelector("#camOffsetZ").value);h.uniformValues.position=[a*i*-u+l,o*i*-u+c,s*-u+f],h.uniformValues.forward=[a*i,o*i,s],h.uniformValues.left=[-o,a,0],h.uniformValues.focal=parseFloat(document.querySelector("#focal").value),h.uniformValues.aperture=parseFloat(document.querySelector("#aperture").value),h.uniformValues.reset=!0,t=!1,n.camera=!1}if(n.scene){h.uniformValues.reset=!0,c(f,o());let{bvh:e,tri:r}=d(f);h.loadScene(e,r),n.scene=!1}n.rendersize&&(await h.resize(parseInt(document.querySelector("#renderX").value),parseInt(document.querySelector("#renderY").value),v),h.uniformValues.reset=!0,n.rendersize=!1),await async function(e){const r=e.device.createCommandEncoder();for(var t=0;t<3;t++)await e.addComputePass(e);e.addFullScreenPass(e.context,r,e),e.device.queue.submit([r.finish()])}(h),window.requestAnimationFrame(S)}}document.querySelector("#download-image").onclick=()=>{w.download=!0},x(),document.querySelector("#reset").onclick=()=>{h.uniformValues.reset=!0},S()}})()})();